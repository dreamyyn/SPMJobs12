
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>demo_meeg_timeseries_generalization</title><meta name="generator" content="MATLAB 8.5"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-12-01"><meta name="DC.source" content="demo_meeg_timeseries_generalization.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">MEEG time-by-time transfer classification</a></li><li><a href="#2">reduce the number of time points</a></li><li><a href="#3">Set up chunks</a></li><li><a href="#4">time-by-time generalization on magneto- and gradio-meters seperately</a></li><li><a href="#5">time-by-time generalization using a searchlight with correlation measure</a></li><li><a href="#6">Show correlation time-by-time generalization searchlight results</a></li><li><a href="#7">show citation information</a></li></ul></div><h2>MEEG time-by-time transfer classification<a name="1"></a></h2><p>This example shows MVPA generalization across time. The input is a time-locked dataset (chan x time), the output is either:</p><div><ul><li>(train_time x test_time) indicating for each combination of time points   in the training and test set how similar the patterns are</li><li>(train_time x test_time x chan), which uses a searchlight and   indicates for each combination of time points in the training and   test set how similar the patterns are in the neighborhood of each   channel.</li></ul></div><p>Results can be visualized in FieldTrip.</p><p>The input dataset involved a paradigm with electrical median nerve stimulation for durations of 2s at 20Hz.</p><p>The code presented here can be adapted for other MEEG analyses, but there are a few potential caveats:</p><div><ul><li>assignment of targets (labels of conditions) is based here on   stimulation periods versus pre-stimulation periods. In typical   analyses the targets should be based on different trial conditions, for   example as set a FieldTrip .trialinfo field.</li><li>the time window used for analyses is rather small. This means that in   particular for time-freq analysis a lot of data is missing, especially   for early and late timepoints in the lower frequency bands. For typical   analyses it may be preferred to use a wider time window.</li><li>the current examples do not perform baseline corrections or signal   normalizations, which may reduce discriminatory power.</li></ul></div><p>Note: running this code requires FieldTrip.</p><div><ol><li>For CoSMoMVPA's copyright information and license terms,   #</li><li>see the COPYING file distributed with CoSMoMVPA.           #</li></ol></div><pre class="codeinput"><span class="comment">% set configuration</span>
config=cosmo_config();
data_path=fullfile(config.tutorial_data_path,<span class="string">'meg_20hz'</span>);

<span class="comment">% show dataset information</span>
readme_fn=fullfile(data_path,<span class="string">'README'</span>);
cosmo_type(readme_fn);

<span class="comment">% reset citation list</span>
cosmo_check_external(<span class="string">'-tic'</span>);

<span class="comment">% load data</span>
data_fn=fullfile(data_path,<span class="string">'subj102_B01_20Hz_timelock.mat'</span>);
data_tl=load(data_fn);

<span class="comment">% convert to cosmomvpa struct</span>
ds_tl=cosmo_meeg_dataset(data_tl);

<span class="comment">% set the target (trial condition)</span>
ds_tl.sa.targets=ds_tl.sa.trialinfo(:,1); <span class="comment">% 1=pre, 2=peri/post</span>

<span class="comment">% set the chunks (independent measurements)</span>
<span class="comment">% in this dataset, the first half of the samples (in order)</span>
<span class="comment">% are the post-trials;</span>
<span class="comment">% the second half the pre-trials</span>
ds_tl.sa.chunks=[(1:145) (1:145)]';

<span class="comment">% in addition give a label to each trial</span>
index2label={<span class="string">'pre'</span>,<span class="string">'post'</span>}; <span class="comment">% 1=pre, 2=peri/post</span>
ds_tl.sa.labels=cellfun(@(x)index2label(x),num2cell(ds_tl.sa.targets));

<span class="comment">% just to check everything is ok</span>
cosmo_check_dataset(ds_tl);
</pre><pre class="codeoutput">Summary
-------
MEG data in raw, time-locked and time-frequency formats.

Contents
--------
- subj102_B01_20Hz.fif            raw MEG recording
- preproc.m                       Matlab preprocessing script (based on 
                                  FieldTrip)
- subj102_B01_20Hz_timefreq.mat   Time-locked data (generated by preproc.m)
- subj102_B01_20Hz_timelock.mat   Time-frequency data  (generated by preproc.m)
- LICENSE                         License file 
- README                          This file

Methods
-------
The dataset involved a paradigm with electrical median nerve stimulation with a 
human participant for durations of 2s at 20Hz. Data was acquired at 1khz using 
a neuromag306 system. 
Trial info in the .mat files: 1=pre-stimulus, 2=peri/post-stimulus

License
-------
The contents are made available by Nathan Weisz &lt;nathanweisz |at| me.com&gt; and 
Gianpaolo Demarchi &lt;gianpaolo.demarchi |at| unitn.it&gt; under the Creative 
Commons CC0 1.0 Universal Public Domain Dedication ("CC0"). See the LICENSE 
file for details, or visit 
http://creativecommons.org/publicdomain/zero/1.0/deed.en.

Acknowledgements
----------------
Thanks to Nathan Weisz and Gianpaolo Demarchi for providing this dataset, and 
an anonymous participant for volunteering during the recordings.

Contact
-------
Nikolaas N. Oosterhof &lt;nikolaas.oosterhof |at| unitn.it&gt;
</pre><h2>reduce the number of time points<a name="2"></a></h2><p>to allow this example to run relatively fast, only use the 'even' timepoints and only use timepoints between 0 and 300 ms relative to stimulus onset. for a publication-quality analysis this step could be omitted.</p><pre class="codeinput">msk=cosmo_dim_match(ds_tl,<span class="string">'time'</span>,@(x) 0&lt;x &amp;x&lt;.3) &amp; <span class="keyword">...</span>
                        mod(ds_tl.fa.time,2)==0;
ds=cosmo_slice(ds_tl,msk,2);
ds=cosmo_dim_prune(ds);
</pre><h2>Set up chunks<a name="3"></a></h2><p>use half of the data for training and half for testing. Here both chunks come from the same session, but it is also possible to use different sessions for training and testing.</p><p>For example, the train data can contain responses to auditory stimuli with the words 'face' and 'house', while the test session measures responses to visual stimuli. In that case the chunks should be assigned 'manually' (without cosmo_chunkize)</p><pre class="codeinput">nchunks=2; <span class="comment">% two chunks are required for this analysis</span>
ds.sa.chunks=cosmo_chunkize(ds,nchunks);
</pre><h2>time-by-time generalization on magneto- and gradio-meters seperately<a name="4"></a></h2><p>compute and plot accuracies for magnetometers and gradiometers separately</p><pre class="codeinput">chan_types={<span class="string">'meg_axial'</span>,<span class="string">'meg_planar'</span>};
nchan_types=numel(chan_types);

<span class="comment">% set arguments for the cosmo_dim_generalization_measure</span>
measure_args=struct();

<span class="comment">% the cosmo_dim_generalization_measure requires that another</span>
<span class="comment">% measure (here: the crossvalidation measure) is specified. The</span>
<span class="comment">% specified measure is applied for each combination of time points</span>
measure_args.measure=@cosmo_crossvalidation_measure;

<span class="comment">% When used ordinary, the cosmo_crossvalidation_measure itself</span>
<span class="comment">% requires two arguments:</span>
<span class="comment">% - classifier (here: LDA)</span>
<span class="comment">% - partitions</span>
<span class="comment">% However, because the cosmo_dim_generalization_measure defines</span>
<span class="comment">% the partitions itself, they are not set here.</span>
measure_args.classifier=@cosmo_classify_lda;

<span class="comment">% define the dimension over which generalization takes place</span>
measure_args.dimension=<span class="string">'time'</span>;

<span class="comment">% define the radius for the time dimension. Here not just a single</span>
<span class="comment">% time-point is used, but also the time-point before it and the time-point</span>
<span class="comment">% after it.</span>
measure_args.radius=1;

<span class="comment">% try both channel types (axial and planar)</span>
<span class="keyword">for</span> k=1:nchan_types
    use_chan_type=chan_types{k};

    <span class="comment">% get layout for mag or planar labels, and select only those channels</span>
    ds_chan_types=cosmo_meeg_chantype(ds);
    ds_chan_idxs=find(cosmo_match(ds_chan_types,use_chan_type));
    feature_msk=cosmo_match(ds.fa.chan,ds_chan_idxs);
    ds_sel=cosmo_slice(ds, feature_msk, 2);

    <span class="comment">% make 'time' a sample dimension</span>
    <span class="comment">% (this necessary for cosmo_dim_generalization_measure)</span>
    ds_time=cosmo_dim_transpose(ds_sel,<span class="string">'time'</span>,1);

    fprintf(<span class="string">'The input for channel type %s is:\n'</span>, use_chan_type)
    cosmo_disp(ds_time);

    <span class="comment">% run transfer across time with the searchlight neighborhood</span>
    <span class="comment">%cdt_ds=cosmo_cartesian_dim_transfer(ds_time,'time',measure,...</span>
    <span class="comment">%                        'args',measure_args);</span>
    cdt_ds=cosmo_dim_generalization_measure(ds_time,measure_args);

    fprintf(<span class="string">'The output is:\n'</span>)
    cosmo_disp(cdt_ds);

    <span class="comment">% unflatten the data to get train_time x test_time matrix</span>
    [data, labels, values]=cosmo_unflatten(cdt_ds,1);

    <span class="comment">% show the results</span>
    figure()
    imagesc(data, [.3 .7]);
    title(sprintf(<span class="string">'classification accuracy for %s'</span>, use_chan_type));
    colorbar();
    nticks=5;

    ytick=round(linspace(1, numel(values{1}), nticks));
    ylabel(strrep(labels{1},<span class="string">'_'</span>,<span class="string">' '</span>));
    set(gca,<span class="string">'Ytick'</span>,ytick,<span class="string">'YTickLabel'</span>,values{1}(ytick));

    xtick=round(linspace(1, numel(values{2}), nticks));
    xlabel(strrep(labels{2},<span class="string">'_'</span>,<span class="string">' '</span>));
    set(gca,<span class="string">'Xtick'</span>,xtick,<span class="string">'XTickLabel'</span>,values{2}(xtick));

    colorbar();
<span class="keyword">end</span>
</pre><pre class="codeoutput">The input for channel type meg_axial is:
.samples                                                                                 
  [  2.94e-13  1.53e-13  2.36e-13  ...   1.19e-13  7.72e-14 -2.62e-14                    
     3.24e-13  1.97e-13   2.4e-13  ...  -1.75e-13 -2.26e-13 -1.94e-13                    
    -1.33e-13 -1.83e-13 -1.25e-13  ...  -1.62e-13 -7.59e-14  4.23e-14                    
        :         :         :               :         :         :                        
    -2.45e-13 -2.22e-13 -2.82e-13  ...   8.02e-14  1.61e-13  1.41e-13                    
     1.15e-14 -3.43e-14 -1.05e-13  ...  -1.96e-14 -4.12e-14  5.86e-15                    
      1.9e-13  1.78e-13  2.86e-13  ...  -3.17e-13 -2.42e-13 -3.42e-13 ]@8700x101         
.sa                                                                                      
  .chunks                                                                                
    [ 1                                                                                  
      2                                                                                  
      1                                                                                  
      :                                                                                  
      1                                                                                  
      2                                                                                  
      1 ]@8700x1                                                                         
  .labels                                                                                
    { 'post'                                                                             
      'post'                                                                             
      'post'                                                                             
        :                                                                                
      'pre'                                                                              
      'pre'                                                                              
      'pre'  }@8700x1                                                                    
  .targets                                                                               
    [ 2                                                                                  
      2                                                                                  
      2                                                                                  
      :                                                                                  
      1                                                                                  
      1                                                                                  
      1 ]@8700x1                                                                         
  .time                                                                                  
    [  1                                                                                 
       1                                                                                 
       1                                                                                 
       :                                                                                 
      30                                                                                 
      30                                                                                 
      30 ]@8700x1                                                                        
  .trialinfo                                                                             
    [ 2         1                                                                        
      2         2                                                                        
      2         3                                                                        
      :        :                                                                         
      1       148                                                                        
      1       149                                                                        
      1       150 ]@8700x2                                                               
.fa                                                                                      
  .chan                                                                                  
    [ 3         6         9  ...  297       300       303 ]@1x101                        
  .transpose_ids                                                                         
    [ 1         2         3  ...  99       100       101 ]@1x101                         
.a                                                                                       
  .fdim                                                                                  
    .labels                                                                              
      { 'chan' }                                                                         
    .values                                                                              
      { { 'MEG0113'  'MEG0112'  'MEG0111' ... 'MEG2642'  'MEG2643'  'MEG2641'   }@1x303 }
  .meeg                                                                                  
    .samples_field                                                                       
      'trial'                                                                            
  .sdim                                                                                  
    .labels                                                                              
      { 'time' }                                                                         
    .values                                                                              
      { [ 0.005                                                                          
          0.015                                                                          
          0.025                                                                          
            :                                                                            
          0.275                                                                          
          0.285                                                                          
          0.295 ]@30x1 }                                                                 
+00:00:13 [####################] -00:00:00  784 / 784
The output is:
.samples                                
  [ 0.528                               
    0.479                               
    0.479                               
      :                                 
      0.5                               
    0.507                               
    0.542 ]@784x1                       
.sa                                     
  .labels                               
    { 'accuracy'                        
      'accuracy'                        
      'accuracy'                        
          :                             
      'accuracy'                        
      'accuracy'                        
      'accuracy' }@784x1                
  .test_time                            
    [  1                                
       2                                
       3                                
       :                                
      26                                
      27                                
      28 ]@784x1                        
  .train_time                           
    [  1                                
       1                                
       1                                
       :                                
      28                                
      28                                
      28 ]@784x1                        
.a                                      
  .sdim                                 
    .labels                             
      { 'train_time'  'test_time' }     
    .values                             
      { [ 0.015         [ 0.015         
          0.025           0.025         
          0.035           0.035         
            :               :           
          0.265           0.265         
          0.275           0.275         
          0.285 ]@28x1    0.285 ]@28x1 }
The input for channel type meg_planar is:
.samples                                                                                 
  [  1.88e-12     9e-12  6.47e-12  ...  -4.35e-12 -4.44e-12  5.89e-12                    
        4e-12  8.53e-12   8.8e-12  ...  -9.94e-12  3.98e-12  8.68e-13                    
    -7.51e-12  5.93e-12 -1.66e-12  ...  -2.57e-12 -5.51e-12 -4.38e-14                    
        :         :         :               :         :         :                        
      3.8e-12 -1.76e-12 -4.97e-12  ...  -3.09e-12     1e-12  4.24e-13                    
    -3.85e-12 -2.32e-12  4.86e-12  ...   1.19e-12  3.11e-12  1.18e-12                    
    -5.57e-12  2.88e-12 -4.12e-13  ...   4.88e-13  5.98e-13 -2.75e-12 ]@8700x202         
.sa                                                                                      
  .chunks                                                                                
    [ 1                                                                                  
      2                                                                                  
      1                                                                                  
      :                                                                                  
      1                                                                                  
      2                                                                                  
      1 ]@8700x1                                                                         
  .labels                                                                                
    { 'post'                                                                             
      'post'                                                                             
      'post'                                                                             
        :                                                                                
      'pre'                                                                              
      'pre'                                                                              
      'pre'  }@8700x1                                                                    
  .targets                                                                               
    [ 2                                                                                  
      2                                                                                  
      2                                                                                  
      :                                                                                  
      1                                                                                  
      1                                                                                  
      1 ]@8700x1                                                                         
  .time                                                                                  
    [  1                                                                                 
       1                                                                                 
       1                                                                                 
       :                                                                                 
      30                                                                                 
      30                                                                                 
      30 ]@8700x1                                                                        
  .trialinfo                                                                             
    [ 2         1                                                                        
      2         2                                                                        
      2         3                                                                        
      :        :                                                                         
      1       148                                                                        
      1       149                                                                        
      1       150 ]@8700x2                                                               
.fa                                                                                      
  .chan                                                                                  
    [ 1         2         4  ...  299       301       302 ]@1x202                        
  .transpose_ids                                                                         
    [ 1         2         3  ...  200       201       202 ]@1x202                        
.a                                                                                       
  .fdim                                                                                  
    .labels                                                                              
      { 'chan' }                                                                         
    .values                                                                              
      { { 'MEG0113'  'MEG0112'  'MEG0111' ... 'MEG2642'  'MEG2643'  'MEG2641'   }@1x303 }
  .meeg                                                                                  
    .samples_field                                                                       
      'trial'                                                                            
  .sdim                                                                                  
    .labels                                                                              
      { 'time' }                                                                         
    .values                                                                              
      { [ 0.005                                                                          
          0.015                                                                          
          0.025                                                                          
            :                                                                            
          0.275                                                                          
          0.285                                                                          
          0.295 ]@30x1 }                                                                 
+00:00:27 [####################] -00:00:00  784 / 784
The output is:
.samples                                
  [ 0.514                               
    0.507                               
    0.486                               
      :                                 
    0.625                               
    0.625                               
    0.611 ]@784x1                       
.sa                                     
  .labels                               
    { 'accuracy'                        
      'accuracy'                        
      'accuracy'                        
          :                             
      'accuracy'                        
      'accuracy'                        
      'accuracy' }@784x1                
  .test_time                            
    [  1                                
       2                                
       3                                
       :                                
      26                                
      27                                
      28 ]@784x1                        
  .train_time                           
    [  1                                
       1                                
       1                                
       :                                
      28                                
      28                                
      28 ]@784x1                        
.a                                      
  .sdim                                 
    .labels                             
      { 'train_time'  'test_time' }     
    .values                             
      { [ 0.015         [ 0.015         
          0.025           0.025         
          0.035           0.035         
            :               :           
          0.265           0.265         
          0.275           0.275         
          0.285 ]@28x1    0.285 ]@28x1 }
</pre><img vspace="5" hspace="5" src="demo_meeg_timeseries_generalization_01.png" alt=""> <img vspace="5" hspace="5" src="demo_meeg_timeseries_generalization_02.png" alt=""> <h2>time-by-time generalization using a searchlight with correlation measure<a name="5"></a></h2><p>how many channel locations in each searchlight</p><pre class="codeinput">nchannel_locations_searchlight=10;


<span class="comment">% make 'time' a sample dimension (necessary for cartesian_dim_transfer)</span>
ds_time=cosmo_dim_transpose(ds_sel,<span class="string">'time'</span>,1);


<span class="comment">% use planar channels as input; output is</span>
<span class="comment">% like combine-planar</span>
use_chan_type=<span class="string">'meg_combined_from_planar'</span>;

<span class="comment">% define searchlight neighborhood</span>
nbrhood=cosmo_meeg_chan_neighborhood(ds_time,<span class="keyword">...</span>
                        <span class="string">'count'</span>,nchannel_locations_searchlight,<span class="keyword">...</span>
                        <span class="string">'chantype'</span>,use_chan_type);

fprintf(<span class="string">'The input is:\n'</span>)
cosmo_disp(ds_time);

fprintf(<span class="string">'The neighborhood is:\n'</span>);
cosmo_disp(nbrhood);

<span class="comment">% set the measure to be the dim generalization measure</span>
measure=@cosmo_dim_generalization_measure;

<span class="comment">% define the arguments for the measure. One of them is called 'measure',</span>
<span class="comment">% because that measure is applied to combinations of samples in the</span>
<span class="comment">% train and test set</span>
measure_args=struct();
measure_args.measure=@cosmo_correlation_measure;
measure_args.radius=1;
measure_args.dimension=<span class="string">'time'</span>;


<span class="comment">% run transfer across time with the searchlight neighborhood</span>
cdt_ds=cosmo_searchlight(ds_time,nbrhood,measure,measure_args);

fprintf(<span class="string">'The output is:\n'</span>)
cosmo_disp(cdt_ds)

<span class="comment">% move {train,test}_time from being sample dimensions to feature</span>
<span class="comment">% dimensions, so they can be mapped to a fieldtrip struct</span>
cdt_tf_ds=cosmo_dim_transpose(cdt_ds,{<span class="string">'train_time'</span>,<span class="string">'test_time'</span>},2);

fprintf(<span class="string">'The output after transposing is:\n'</span>)
cosmo_disp(cdt_ds)

<span class="comment">% trick fieldtrip into thinking this is a time-freq-chan dataset, by</span>
<span class="comment">% renaming train_time and test_time to freq and time, respectively</span>
cdt_tf_ds=cosmo_dim_rename(cdt_tf_ds,<span class="string">'train_time'</span>,<span class="string">'freq'</span>);
cdt_tf_ds=cosmo_dim_rename(cdt_tf_ds,<span class="string">'test_time'</span>,<span class="string">'time'</span>);
</pre><pre class="codeoutput">The input is:
.samples                                                                                 
  [  1.88e-12     9e-12  6.47e-12  ...  -4.35e-12 -4.44e-12  5.89e-12                    
        4e-12  8.53e-12   8.8e-12  ...  -9.94e-12  3.98e-12  8.68e-13                    
    -7.51e-12  5.93e-12 -1.66e-12  ...  -2.57e-12 -5.51e-12 -4.38e-14                    
        :         :         :               :         :         :                        
      3.8e-12 -1.76e-12 -4.97e-12  ...  -3.09e-12     1e-12  4.24e-13                    
    -3.85e-12 -2.32e-12  4.86e-12  ...   1.19e-12  3.11e-12  1.18e-12                    
    -5.57e-12  2.88e-12 -4.12e-13  ...   4.88e-13  5.98e-13 -2.75e-12 ]@8700x202         
.sa                                                                                      
  .chunks                                                                                
    [ 1                                                                                  
      2                                                                                  
      1                                                                                  
      :                                                                                  
      1                                                                                  
      2                                                                                  
      1 ]@8700x1                                                                         
  .labels                                                                                
    { 'post'                                                                             
      'post'                                                                             
      'post'                                                                             
        :                                                                                
      'pre'                                                                              
      'pre'                                                                              
      'pre'  }@8700x1                                                                    
  .targets                                                                               
    [ 2                                                                                  
      2                                                                                  
      2                                                                                  
      :                                                                                  
      1                                                                                  
      1                                                                                  
      1 ]@8700x1                                                                         
  .time                                                                                  
    [  1                                                                                 
       1                                                                                 
       1                                                                                 
       :                                                                                 
      30                                                                                 
      30                                                                                 
      30 ]@8700x1                                                                        
  .trialinfo                                                                             
    [ 2         1                                                                        
      2         2                                                                        
      2         3                                                                        
      :        :                                                                         
      1       148                                                                        
      1       149                                                                        
      1       150 ]@8700x2                                                               
.fa                                                                                      
  .chan                                                                                  
    [ 1         2         4  ...  299       301       302 ]@1x202                        
  .transpose_ids                                                                         
    [ 1         2         3  ...  200       201       202 ]@1x202                        
.a                                                                                       
  .fdim                                                                                  
    .labels                                                                              
      { 'chan' }                                                                         
    .values                                                                              
      { { 'MEG0113'  'MEG0112'  'MEG0111' ... 'MEG2642'  'MEG2643'  'MEG2641'   }@1x303 }
  .meeg                                                                                  
    .samples_field                                                                       
      'trial'                                                                            
  .sdim                                                                                  
    .labels                                                                              
      { 'time' }                                                                         
    .values                                                                              
      { [ 0.005                                                                          
          0.015                                                                          
          0.025                                                                          
            :                                                                            
          0.275                                                                          
          0.285                                                                          
          0.295 ]@30x1 }                                                                 
The neighborhood is:
.neighbors                                                                                                             
  { [ 1         2         3  ...  24       109       110 ]@1x20                                                        
    [ 1         2         3  ...  24        39        40 ]@1x20                                                        
    [ 1         2         3  ...  24       109       110 ]@1x20                                                        
                                  :                                                                                    
    [ 97        98       105  ...  200       201       202 ]@1x19                                                      
    [ 174       175       181  ...  200       201       202 ]@1x20                                                     
    [ 97        98       180  ...  200       201       202 ]@1x19  }@102x1                                             
.fa                                                                                                                    
  .chan                                                                                                                
    [ 1         2         3  ...  100       101       102 ]@1x102                                                      
.a                                                                                                                     
  .fdim                                                                                                                
    .labels                                                                                                            
      { 'chan' }                                                                                                       
    .values                                                                                                            
      { { 'MEG0112+0113'  'MEG0122+0123'  'MEG0132+0133' ... 'MEG2622+2623'  'MEG2632+2633'  'MEG2642+2643'   }@1x102 }
  .meeg                                                                                                                
    .samples_field                                                                                                     
      'trial'                                                                                                          
.origin                                                                                                                
  .fa                                                                                                                  
    .chan                                                                                                              
      [ 1         2         4  ...  299       301       302 ]@1x202                                                    
    .transpose_ids                                                                                                     
      [ 1         2         3  ...  200       201       202 ]@1x202                                                    
  .a                                                                                                                   
    .fdim                                                                                                              
      .labels                                                                                                          
        { 'chan' }                                                                                                     
      .values                                                                                                          
        { { &lt;char&gt;@1x7  &lt;char&gt;@1x7  &lt;char&gt;@1x7 ... &lt;char&gt;@1x7  &lt;char&gt;@1x7  &lt;char&gt;@1x7   }@1x303 }                      
    .meeg                                                                                                              
      .samples_field                                                                                                   
        'trial'                                                                                                        
    .sdim                                                                                                              
      .labels                                                                                                          
        { 'time' }                                                                                                     
      .values                                                                                                          
        { [ 0.005                                                                                                      
            0.015                                                                                                      
            0.025                                                                                                      
              :                                                                                                        
            0.275                                                                                                      
            0.285                                                                                                      
            0.295 ]@30x1 }                                                                                             
+00:14:58 [####################] -00:00:00  
The output is:
.a                                                                                                                     
  .fdim                                                                                                                
    .labels                                                                                                            
      { 'chan' }                                                                                                       
    .values                                                                                                            
      { { 'MEG0112+0113'  'MEG0122+0123'  'MEG0132+0133' ... 'MEG2622+2623'  'MEG2632+2633'  'MEG2642+2643'   }@1x102 }
  .meeg                                                                                                                
    .samples_field                                                                                                     
      'trial'                                                                                                          
  .sdim                                                                                                                
    .labels                                                                                                            
      { 'train_time'  'test_time' }                                                                                    
    .values                                                                                                            
      { [ 0.015         [ 0.015                                                                                        
          0.025           0.025                                                                                        
          0.035           0.035                                                                                        
            :               :                                                                                          
          0.265           0.265                                                                                        
          0.275           0.275                                                                                        
          0.285 ]@28x1    0.285 ]@28x1 }                                                                               
.fa                                                                                                                    
  .chan                                                                                                                
    [ 1         2         3  ...  100       101       102 ]@1x102                                                      
  .center_ids                                                                                                          
    [ 1         2         3  ...  100       101       102 ]@1x102                                                      
.samples                                                                                                               
  [ -0.00468    0.0748   -0.0547  ...  0.331      0.28     0.232                                                       
      -0.125    0.0217    -0.151  ...  0.336      0.22     0.264                                                       
      -0.178   -0.0212    -0.177  ...  0.305      0.22     0.285                                                       
        :         :         :            :         :         :                                                         
     -0.0953  -0.00198     0.176  ...  0.134     0.413     0.329                                                       
     -0.0145     0.177     0.194  ...  0.232     0.468     0.431                                                       
       0.116     0.326     0.278  ...   0.25     0.401     0.414 ]@784x102                                             
.sa                                                                                                                    
  .labels                                                                                                              
    { 'corr'                                                                                                           
      'corr'                                                                                                           
      'corr'                                                                                                           
        :                                                                                                              
      'corr'                                                                                                           
      'corr'                                                                                                           
      'corr' }@784x1                                                                                                   
  .test_time                                                                                                           
    [  1                                                                                                               
       2                                                                                                               
       3                                                                                                               
       :                                                                                                               
      26                                                                                                               
      27                                                                                                               
      28 ]@784x1                                                                                                       
  .train_time                                                                                                          
    [  1                                                                                                               
       1                                                                                                               
       1                                                                                                               
       :                                                                                                               
      28                                                                                                               
      28                                                                                                               
      28 ]@784x1                                                                                                       
The output after transposing is:
.a                                                                                                                     
  .fdim                                                                                                                
    .labels                                                                                                            
      { 'chan' }                                                                                                       
    .values                                                                                                            
      { { 'MEG0112+0113'  'MEG0122+0123'  'MEG0132+0133' ... 'MEG2622+2623'  'MEG2632+2633'  'MEG2642+2643'   }@1x102 }
  .meeg                                                                                                                
    .samples_field                                                                                                     
      'trial'                                                                                                          
  .sdim                                                                                                                
    .labels                                                                                                            
      { 'train_time'  'test_time' }                                                                                    
    .values                                                                                                            
      { [ 0.015         [ 0.015                                                                                        
          0.025           0.025                                                                                        
          0.035           0.035                                                                                        
            :               :                                                                                          
          0.265           0.265                                                                                        
          0.275           0.275                                                                                        
          0.285 ]@28x1    0.285 ]@28x1 }                                                                               
.fa                                                                                                                    
  .chan                                                                                                                
    [ 1         2         3  ...  100       101       102 ]@1x102                                                      
  .center_ids                                                                                                          
    [ 1         2         3  ...  100       101       102 ]@1x102                                                      
.samples                                                                                                               
  [ -0.00468    0.0748   -0.0547  ...  0.331      0.28     0.232                                                       
      -0.125    0.0217    -0.151  ...  0.336      0.22     0.264                                                       
      -0.178   -0.0212    -0.177  ...  0.305      0.22     0.285                                                       
        :         :         :            :         :         :                                                         
     -0.0953  -0.00198     0.176  ...  0.134     0.413     0.329                                                       
     -0.0145     0.177     0.194  ...  0.232     0.468     0.431                                                       
       0.116     0.326     0.278  ...   0.25     0.401     0.414 ]@784x102                                             
.sa                                                                                                                    
  .labels                                                                                                              
    { 'corr'                                                                                                           
      'corr'                                                                                                           
      'corr'                                                                                                           
        :                                                                                                              
      'corr'                                                                                                           
      'corr'                                                                                                           
      'corr' }@784x1                                                                                                   
  .test_time                                                                                                           
    [  1                                                                                                               
       2                                                                                                               
       3                                                                                                               
       :                                                                                                               
      26                                                                                                               
      27                                                                                                               
      28 ]@784x1                                                                                                       
  .train_time                                                                                                          
    [  1                                                                                                               
       1                                                                                                               
       1                                                                                                               
       :                                                                                                               
      28                                                                                                               
      28                                                                                                               
      28 ]@784x1                                                                                                       
</pre><h2>Show correlation time-by-time generalization searchlight results<a name="6"></a></h2><pre class="codeinput"><span class="comment">% determine layout</span>
layout=cosmo_meeg_find_layout(cdt_tf_ds);


<span class="comment">% convert to fieldtrip format</span>
ft=cosmo_map2meeg(cdt_tf_ds);

<span class="comment">% show train_time x test_time x chan figure</span>
<span class="comment">%</span>
<span class="comment">% * train_time is on the vertical ('freq') axis</span>
<span class="comment">% * test_time on the horizontal ('time') axis)</span>
figure();
cfg = [];
cfg.interactive = <span class="string">'yes'</span>;
cfg.showlabels = <span class="string">'yes'</span>;
cfg.zlim=[-1 1];
cfg.layout       = layout;
ft_multiplotTFR(cfg, ft);

<span class="comment">% show train_time x test_time figure for selected channels</span>
figure();
cfg = [];
cfg.interactive = <span class="string">'yes'</span>;
cfg.showlabels = <span class="string">'yes'</span>;
cfg.zlim=[-1 1];
cfg.layout       = layout;
cfg.channel={<span class="string">'MEG0322+0323'</span>, <span class="string">'MEG0332+0333'</span>, <span class="string">'MEG0412+0413'</span>, <span class="keyword">...</span>
            <span class="string">'MEG0422+0423'</span>, <span class="string">'MEG0632+0633'</span>, <span class="string">'MEG0642+0643'</span>};

ft_singleplotTFR(cfg,ft);

<span class="comment">% show channel topology for timewindow over train_time x test_time</span>
figure();
cfg = [];
cfg.interactive = <span class="string">'yes'</span>;
cfg.xlim=[.2 .25];
cfg.ylim=[.2 .25];
cfg.zlim=[-1 1];
cfg.layout       = layout;
ft_topoplotTFR(cfg, ft);
</pre><pre class="codeoutput">the call to "ft_prepare_layout" took 0 seconds and required the additional allocation of an estimated 1 MB
the call to "ft_multiplotTFR" took 10 seconds and required the additional allocation of an estimated 56 MB
the call to "ft_singleplotTFR" took 0 seconds and required the additional allocation of an estimated 11 MB
the call to "ft_prepare_layout" took 0 seconds and required the additional allocation of an estimated 0 MB
the call to "ft_topoplotTFR" took 0 seconds and required the additional allocation of an estimated 8 MB
</pre><img vspace="5" hspace="5" src="demo_meeg_timeseries_generalization_03.png" alt=""> <img vspace="5" hspace="5" src="demo_meeg_timeseries_generalization_04.png" alt=""> <img vspace="5" hspace="5" src="demo_meeg_timeseries_generalization_05.png" alt=""> <h2>show citation information<a name="7"></a></h2><pre class="codeinput">cosmo_check_external(<span class="string">'-cite'</span>);
</pre><pre class="codeoutput">If you use CoSMoMVPA and/or some other toolboxes for a publication, please cite:

R. Oostenveld, P. Fries, E. Maris, J.-M. Schoffelen (2011). FieldTrip: Open Source Software for Advanced Analysis of MEG, EEG, and Invasive Electrophysiological Data, Computational Intelligence and Neuroscience, vol. 2011, Article ID 156869, 9 pages.doi:10.1155/2011/156869. FieldTrip toolbox available online from http://fieldtrip.fcdonders.nl

N. N. Oosterhof, A. C. Connolly, J. V. Haxby (2016). CoSMoMVPA: multi-modal multivariate pattern analysis of neuroimaging data in Matlab / GNU Octave. Frontiers in Neuroinformatics, doi:10.3389/fninf.2016.00027.. CoSMoMVPA toolbox available online from http://cosmomvpa.org

The Mathworks, Natick, MA, United States. Matlab 8.5.0.197613 (R2015a) (February 12, 2015). available online from http://www.mathworks.com

</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% MEEG time-by-time transfer classification
%
% This example shows MVPA generalization across time. The input is a
% time-locked dataset (chan x time), the output is either:
%
% * (train_time x test_time) indicating for each combination of time points
%   in the training and test set how similar the patterns are
% * (train_time x test_time x chan), which uses a searchlight and
%   indicates for each combination of time points in the training and
%   test set how similar the patterns are in the neighborhood of each
%   channel.
%
% Results can be visualized in FieldTrip.
%
% The input dataset involved a paradigm with electrical median nerve
% stimulation for durations of 2s at 20Hz.
%
% The code presented here can be adapted for other MEEG analyses, but
% there are a few potential caveats:
%
% * assignment of targets (labels of conditions) is based here on
%   stimulation periods versus pre-stimulation periods. In typical
%   analyses the targets should be based on different trial conditions, for
%   example as set a FieldTrip .trialinfo field.
% * the time window used for analyses is rather small. This means that in
%   particular for time-freq analysis a lot of data is missing, especially
%   for early and late timepoints in the lower frequency bands. For typical
%   analyses it may be preferred to use a wider time window.
% * the current examples do not perform baseline corrections or signal
%   normalizations, which may reduce discriminatory power.
%
% Note: running this code requires FieldTrip.
%
% #   For CoSMoMVPA's copyright information and license terms,   #
% #   see the COPYING file distributed with CoSMoMVPA.           #

% set configuration
config=cosmo_config();
data_path=fullfile(config.tutorial_data_path,'meg_20hz');

% show dataset information
readme_fn=fullfile(data_path,'README');
cosmo_type(readme_fn);

% reset citation list
cosmo_check_external('-tic');

% load data
data_fn=fullfile(data_path,'subj102_B01_20Hz_timelock.mat');
data_tl=load(data_fn);

% convert to cosmomvpa struct
ds_tl=cosmo_meeg_dataset(data_tl);

% set the target (trial condition)
ds_tl.sa.targets=ds_tl.sa.trialinfo(:,1); % 1=pre, 2=peri/post

% set the chunks (independent measurements)
% in this dataset, the first half of the samples (in order)
% are the post-trials;
% the second half the pre-trials
ds_tl.sa.chunks=[(1:145) (1:145)]';

% in addition give a label to each trial
index2label={'pre','post'}; % 1=pre, 2=peri/post
ds_tl.sa.labels=cellfun(@(x)index2label(x),num2cell(ds_tl.sa.targets));

% just to check everything is ok
cosmo_check_dataset(ds_tl);

%% reduce the number of time points
% to allow this example to run relatively fast, only use the 'even'
% timepoints and only use timepoints between 0 and 300 ms relative to
% stimulus onset.
% for a publication-quality analysis this step could be omitted.
msk=cosmo_dim_match(ds_tl,'time',@(x) 0<x &x<.3) & ...
                        mod(ds_tl.fa.time,2)==0;
ds=cosmo_slice(ds_tl,msk,2);
ds=cosmo_dim_prune(ds);


%% Set up chunks
% use half of the data for training and half for testing. Here both chunks
% come from the same session, but it is also possible to use different
% sessions for training and testing.
%
% For example, the train data can contain responses to auditory stimuli
% with the words 'face' and 'house', while the test session measures
% responses to visual stimuli. In that case the chunks should be assigned
% 'manually' (without cosmo_chunkize)
nchunks=2; % two chunks are required for this analysis
ds.sa.chunks=cosmo_chunkize(ds,nchunks);


%% time-by-time generalization on magneto- and gradio-meters seperately
% compute and plot accuracies for magnetometers and gradiometers separately
chan_types={'meg_axial','meg_planar'};
nchan_types=numel(chan_types);

% set arguments for the cosmo_dim_generalization_measure
measure_args=struct();

% the cosmo_dim_generalization_measure requires that another
% measure (here: the crossvalidation measure) is specified. The
% specified measure is applied for each combination of time points
measure_args.measure=@cosmo_crossvalidation_measure;

% When used ordinary, the cosmo_crossvalidation_measure itself
% requires two arguments:
% - classifier (here: LDA)
% - partitions
% However, because the cosmo_dim_generalization_measure defines
% the partitions itself, they are not set here.
measure_args.classifier=@cosmo_classify_lda;

% define the dimension over which generalization takes place
measure_args.dimension='time';

% define the radius for the time dimension. Here not just a single
% time-point is used, but also the time-point before it and the time-point
% after it.
measure_args.radius=1;

% try both channel types (axial and planar)
for k=1:nchan_types
    use_chan_type=chan_types{k};

    % get layout for mag or planar labels, and select only those channels
    ds_chan_types=cosmo_meeg_chantype(ds);
    ds_chan_idxs=find(cosmo_match(ds_chan_types,use_chan_type));
    feature_msk=cosmo_match(ds.fa.chan,ds_chan_idxs);
    ds_sel=cosmo_slice(ds, feature_msk, 2);

    % make 'time' a sample dimension
    % (this necessary for cosmo_dim_generalization_measure)
    ds_time=cosmo_dim_transpose(ds_sel,'time',1);

    fprintf('The input for channel type %s is:\n', use_chan_type)
    cosmo_disp(ds_time);

    % run transfer across time with the searchlight neighborhood
    %cdt_ds=cosmo_cartesian_dim_transfer(ds_time,'time',measure,...
    %                        'args',measure_args);
    cdt_ds=cosmo_dim_generalization_measure(ds_time,measure_args);

    fprintf('The output is:\n')
    cosmo_disp(cdt_ds);

    % unflatten the data to get train_time x test_time matrix
    [data, labels, values]=cosmo_unflatten(cdt_ds,1);

    % show the results
    figure()
    imagesc(data, [.3 .7]);
    title(sprintf('classification accuracy for %s', use_chan_type));
    colorbar();
    nticks=5;

    ytick=round(linspace(1, numel(values{1}), nticks));
    ylabel(strrep(labels{1},'_',' '));
    set(gca,'Ytick',ytick,'YTickLabel',values{1}(ytick));

    xtick=round(linspace(1, numel(values{2}), nticks));
    xlabel(strrep(labels{2},'_',' '));
    set(gca,'Xtick',xtick,'XTickLabel',values{2}(xtick));

    colorbar();
end


%% time-by-time generalization using a searchlight with correlation measure
% how many channel locations in each searchlight
nchannel_locations_searchlight=10;


% make 'time' a sample dimension (necessary for cartesian_dim_transfer)
ds_time=cosmo_dim_transpose(ds_sel,'time',1);


% use planar channels as input; output is
% like combine-planar
use_chan_type='meg_combined_from_planar';

% define searchlight neighborhood
nbrhood=cosmo_meeg_chan_neighborhood(ds_time,...
                        'count',nchannel_locations_searchlight,...
                        'chantype',use_chan_type);

fprintf('The input is:\n')
cosmo_disp(ds_time);

fprintf('The neighborhood is:\n');
cosmo_disp(nbrhood);

% set the measure to be the dim generalization measure
measure=@cosmo_dim_generalization_measure;

% define the arguments for the measure. One of them is called 'measure',
% because that measure is applied to combinations of samples in the
% train and test set
measure_args=struct();
measure_args.measure=@cosmo_correlation_measure;
measure_args.radius=1;
measure_args.dimension='time';


% run transfer across time with the searchlight neighborhood
cdt_ds=cosmo_searchlight(ds_time,nbrhood,measure,measure_args);

fprintf('The output is:\n')
cosmo_disp(cdt_ds)

% move {train,test}_time from being sample dimensions to feature
% dimensions, so they can be mapped to a fieldtrip struct
cdt_tf_ds=cosmo_dim_transpose(cdt_ds,{'train_time','test_time'},2);

fprintf('The output after transposing is:\n')
cosmo_disp(cdt_ds)

% trick fieldtrip into thinking this is a time-freq-chan dataset, by
% renaming train_time and test_time to freq and time, respectively
cdt_tf_ds=cosmo_dim_rename(cdt_tf_ds,'train_time','freq');
cdt_tf_ds=cosmo_dim_rename(cdt_tf_ds,'test_time','time');

%% Show correlation time-by-time generalization searchlight results

% determine layout
layout=cosmo_meeg_find_layout(cdt_tf_ds);


% convert to fieldtrip format
ft=cosmo_map2meeg(cdt_tf_ds);

% show train_time x test_time x chan figure
%
% * train_time is on the vertical ('freq') axis
% * test_time on the horizontal ('time') axis)
figure();
cfg = [];
cfg.interactive = 'yes';
cfg.showlabels = 'yes';
cfg.zlim=[-1 1];
cfg.layout       = layout;
ft_multiplotTFR(cfg, ft);

% show train_time x test_time figure for selected channels
figure();
cfg = [];
cfg.interactive = 'yes';
cfg.showlabels = 'yes';
cfg.zlim=[-1 1];
cfg.layout       = layout;
cfg.channel={'MEG0322+0323', 'MEG0332+0333', 'MEG0412+0413', ...
            'MEG0422+0423', 'MEG0632+0633', 'MEG0642+0643'};

ft_singleplotTFR(cfg,ft);

% show channel topology for timewindow over train_time x test_time
figure();
cfg = [];
cfg.interactive = 'yes';
cfg.xlim=[.2 .25];
cfg.ylim=[.2 .25];
cfg.zlim=[-1 1];
cfg.layout       = layout;
ft_topoplotTFR(cfg, ft);


%% show citation information

cosmo_check_external('-cite');


##### SOURCE END #####
--></body></html>