    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>test meeg io &#8212; CoSMo Multivariate Pattern Analysis toolbox 1.0rc1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0rc1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="test meeg layout collection" href="test_meeg_layout_collection.html" />
    <link rel="prev" title="test meeg find layout" href="test_meeg_find_layout.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="test_meeg_layout_collection.html" title="test meeg layout collection"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="test_meeg_find_layout.html" title="test meeg find layout"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_test.html" accesskey="U">CoSMoMVPA unit tests</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="test-meeg-io">
<span id="id1"></span><h1>test meeg io<a class="headerlink" href="#test-meeg-io" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-matlab"><div class="highlight"><pre><span></span>function test_suite=test_meeg_io()
% tests for MEEG input/output
%
% #   For CoSMoMVPA&#39;s copyright information and license terms,   #
% #   see the COPYING file distributed with CoSMoMVPA.           #
    try % assignment of &#39;localfunctions&#39; is necessary in Matlab &gt;= 2016
        test_functions=localfunctions();
    catch % no problem; early Matlab versions can use initTestSuite fine
    end
    initTestSuite;


function test_meeg_ft_dataset()
    aet=@(varargin)assertExceptionThrown(@()...
                    cosmo_meeg_dataset(varargin{:}),&#39;&#39;);

    dimords=get_ft_dimords();
    n=numel(dimords);
    for k=1:n
        dimord=dimords{k};
        [ft,fdim,data_label]=generate_ft_struct(dimord);
        ds=cosmo_meeg_dataset(ft);
        assertEqual(ds.a.fdim,fdim);

        [nsamples,nfeatures]=size(ds.samples);

        % check feature sizes
        fdim_sizes=cellfun(@numel,fdim.values);
        assertEqual(prod(fdim_sizes),nfeatures);

        % check sample size
        data=ft.(data_label);
        data_size=size(data);
        has_rpt=nsamples&gt;1;
        if has_rpt
            assertEqual(data_size(2:end)&#39;,fdim_sizes);
        else
            assertEqual(data_size&#39;,fdim_sizes);
        end

        assertElementsAlmostEqual(data(:),ds.samples(:));

        ds2=cosmo_slice(ds,randperm(nfeatures),2);
        ft2=cosmo_map2meeg(ds2);

        if isfield(ft,&#39;cfg&#39;)
            ft=rmfield(ft,&#39;cfg&#39;);
        end

        if isfield(ft,&#39;avg&#39;) &amp;&amp; isfield(ft,&#39;trial&#39;)
            ft=rmfield(ft,&#39;avg&#39;);
        end

        assertEqual(ft,ft2);

        % wrong size trialinfo should not store trialinfo
        assertTrue(isfield(ds2.sa,&#39;trialinfo&#39;));
        ft.trialinfo=[1;2];
        ds3=cosmo_meeg_dataset(ft);
        assertFalse(isfield(ds3.sa,&#39;trialinfo&#39;));
    end

    aet(struct());
    aet(struct(&#39;avg&#39;,1));
    aet(struct(&#39;avg&#39;,1,&#39;dimord&#39;,&#39;rpt_foo&#39;));

function test_meeg_ft_dataset_trials()
    aet=@(varargin)assertExceptionThrown(@()...
                    cosmo_meeg_dataset(varargin{:}),&#39;&#39;);

    dimords=get_ft_dimords();
    n=numel(dimords);
    for k=1:n
        dimord=dimords{k};
        ft=generate_ft_struct(dimord);
        ds=cosmo_meeg_dataset(ft);

        % check subset of trials option
        ntrials=size(ds.samples,1);
        trial_idx=ceil(rand(1,2)*ntrials);
        ds_single_trial=cosmo_meeg_dataset(ft,...
                                    &#39;trials&#39;,trial_idx);
        assertEqual(cosmo_slice(ds,trial_idx),ds_single_trial);
        ds_single_trial=cosmo_meeg_dataset(ft,...
                                    cosmo_structjoin(&#39;trials&#39;,trial_idx));
        assertEqual(cosmo_slice(ds,trial_idx),ds_single_trial);

        illegal_args={ntrials+1,0,struct,cell(1,0),&#39;foo&#39;,true,1.5};
        for j=1:numel(illegal_args)
            arg=illegal_args{j};
            aet(ft,&#39;trials&#39;,arg);
        end
    end



function test_synthetic_meeg_dataset()
    combis=cosmo_cartprod({{&#39;timelock&#39;,&#39;timefreq&#39;,&#39;source&#39;},...
                            {&#39;tiny&#39;,&#39;small&#39;,&#39;normal&#39;,&#39;big&#39;,&#39;huge&#39;}});
    for k=1:4:size(combis,1)
        ds=cosmo_synthetic_dataset(&#39;type&#39;,combis{k,1},...
                                        &#39;size&#39;,combis{k,2});

        ft=cosmo_map2meeg(ds);
        ds2=cosmo_meeg_dataset(ft);
        assertEqual(ds.samples,ds2.samples);
        assertEqual(ds.fa,ds2.fa);
        assertEqual(ds.a.meeg.samples_field,ds2.a.meeg.samples_field);
    end

    ds2=cosmo_meeg_dataset(ds,&#39;targets&#39;,1);
    assertTrue(all(ds2.sa.targets==1));
    assertExceptionThrown(@()cosmo_meeg_dataset(ds,&#39;targets&#39;,[1 2]),&#39;&#39;);


function test_meeg_eeglab_txt_io()
    ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;meeg&#39;);

    tmp_fn=sprintf(&#39;_tmp_%06.0f.txt&#39;,rand()*1e5);
    file_remover=onCleanup(@()delete(tmp_fn));
    fid=fopen(tmp_fn,&#39;w&#39;);
    file_closer=onCleanup(@()fclose(fid));

    chans=[{&#39; &#39;} ds.a.fdim.values{1}];
    fprintf(fid,&#39;%s\t&#39;,chans{:});
    fprintf(fid,&#39;\n&#39;);

    times=ds.a.fdim.values{2};
    ntime=numel(times);
    nsamples=size(ds.samples,1);

    for k=1:nsamples
        for j=1:ntime
            data=ds.samples(k,ds.fa.time==j);
            fprintf(fid,&#39;%.3f&#39;,times(j));
            fprintf(fid,&#39;\t%.4f&#39;,data);
            fprintf(fid,&#39;\n&#39;);
        end
    end

    fclose(fid);
    ds2=cosmo_meeg_dataset(tmp_fn);

    assertElementsAlmostEqual(ds.samples,ds2.samples,&#39;absolute&#39;,1e-4);
    assertEqual(ds.a.fdim.values{1},ds2.a.fdim.values{1});
    assertElementsAlmostEqual(ds.a.fdim.values{2},...
                                    1000*ds2.a.fdim.values{2});
    assertEqual(ds.a.fdim.labels,ds2.a.fdim.labels);
    assertEqual(ds.fa,ds2.fa);

    % test trials option
    nsamples=size(ds.samples,1);
    trial_idx=ceil(rand(1,2)*nsamples);
    ds_trials=cosmo_meeg_dataset(tmp_fn,&#39;trials&#39;,trial_idx);
    ds_expected_trials=cosmo_slice(ds,trial_idx);
    assertElementsAlmostEqual(ds_trials.samples,...
                                ds_expected_trials.samples,...
                                &#39;absolute&#39;,1e-4);

    % test illegal options
    aet=@(varargin)assertExceptionThrown(@()...
                            cosmo_meeg_dataset(varargin{:}),&#39;&#39;);
    illegal_args={nsamples+1,0,struct,{},&#39;foo&#39;,true,1.5};
    for j=1:numel(illegal_args)
        arg=illegal_args{j};
        aet(tmp_fn,&#39;trials&#39;,arg);
        aet(tmp_fn,cosmo_structjoin(&#39;trials&#39;,arg));
    end

    % add bogus data, expect exception
    fid=fopen(tmp_fn,&#39;a&#39;);
    fprintf(fid,&#39;.3&#39;);
    fclose(fid);
    file_closer=[];

    aet(tmp_fn);

    tmp2_fn=sprintf(&#39;_tmp_%06.0f.txt&#39;,rand()*1e5);
    file_remover2=onCleanup(@()delete(tmp2_fn));
    cosmo_map2meeg(ds2,tmp2_fn);
    ds3=cosmo_meeg_dataset(tmp2_fn);
    assertEqual(ds2,ds3);


function test_meeg_ft_io()
    ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;meeg&#39;);
    tmp_fn=sprintf(&#39;_tmp_%06.0f.mat&#39;,rand()*1e5);
    file_remover=onCleanup(@()delete(tmp_fn));

    cosmo_map2meeg(ds,tmp_fn);
    ds2=cosmo_meeg_dataset(tmp_fn);
    assertEqual(ds.a.meeg.samples_field,ds2.a.meeg.samples_field);
    ds.a.meeg=[];
    ds.sa=struct();
    ds2.a.meeg=[];

    % deal with rounding errors in Octave
    assertElementsAlmostEqual(ds.samples,ds2.samples);
    assertElementsAlmostEqual(ds.a.fdim.values{2},ds2.a.fdim.values{2});

    ds3=cosmo_meeg_dataset(ds2);
    assertEqual(ds2,ds3);

    ds2.samples=ds.samples;
    ds2.a.fdim.values{2}=ds.a.fdim.values{2};
    assertEqual(ds,ds2);



function test_meeg_ft_io_exceptions()
    aeti=@(varargin)assertExceptionThrown(@()...
                    cosmo_meeg_dataset(varargin{:}),&#39;&#39;);
    aeto=@(varargin)assertExceptionThrown(@()...
                    cosmo_map2meeg(varargin{:}),&#39;&#39;);
    ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;timefreq&#39;);
    aeti(&#39;file_without_extension&#39;);
    aeti(&#39;file.with_unknown_extension&#39;);

    aeto(ds,&#39;file_without_extension&#39;);
    aeto(ds,&#39;file.with_unknown_extension&#39;);

    aeto(ds,&#39;eeglab_timelock.txt&#39;); % not supported


function dimords=get_ft_dimords()
    dimords={   &#39;chan_time&#39;,...
                &#39;rpt_chan_time&#39;...
                &#39;subj_chan_time&#39;...
                &#39;chan_freq&#39;,...
                &#39;rpt_chan_freq&#39;,...
                &#39;subj_chan_freq&#39;,...
                &#39;chan_freq_time&#39;,...
                &#39;rpt_chan_freq_time&#39;,...
                &#39;subj_chan_freq_time&#39;,...
                };

function [ft,fdim,data_label]=generate_ft_struct(dimord)
    seed=1;

    fdim=struct();
    fdim.values=cell(3,1);
    fdim.labels=cell(3,1);

    ft=struct();
    ft.dimord=dimord;

    dims=cosmo_strsplit(dimord,&#39;_&#39;);
    ndim=numel(dims);
    sizes=[3 4 5 6];

    chan_values={&#39;MEG0113&#39; &#39;MEG0112&#39; &#39;MEG0111&#39; &#39;MEG0122&#39;...
                    &#39;MEG0123&#39; &#39;MEG0121&#39; &#39;MEG0132&#39;};
    freq_values=(2:2:24);
    time_values=(-1:.1:2);

    data_label=&#39;avg&#39;;
    ntrials=1;
    nkeep=0;

    for k=1:ndim
        idxs=1:sizes(k);
        switch dims{k}
            case &#39;rpt&#39;
                data_label=&#39;trial&#39;;
                ntrials=numel(idxs);

            case &#39;subj&#39;
                data_label=&#39;individual&#39;;
                ntrials=numel(idxs);

            case &#39;chan&#39;
                ft.label=chan_values(idxs);
                nkeep=nkeep+1;
                fdim.values{nkeep}=ft.label;
                fdim.labels{nkeep}=&#39;chan&#39;;

            case &#39;freq&#39;
                ft.freq=freq_values(idxs);
                data_label=&#39;powspctrm&#39;;
                nkeep=nkeep+1;
                fdim.values{nkeep}=ft.freq;
                fdim.labels{nkeep}=&#39;freq&#39;;

            case &#39;time&#39;
                ft.time=time_values(idxs);
                nkeep=nkeep+1;
                fdim.values{nkeep}=ft.time;
                fdim.labels{nkeep}=&#39;time&#39;;

        end
    end

    fdim.values=fdim.values(1:nkeep);
    fdim.labels=fdim.labels(1:nkeep);

    keep_sizes=sizes(1:k);
    ft.(data_label)=norminv(cosmo_rand(keep_sizes,&#39;seed&#39;,seed));
    ft.cfg=struct();
    ft.trialinfo=[(1:ntrials);(ntrials:-1:1)]&#39;;

    if strcmp(data_label,&#39;trial&#39;)
        ft.avg=mean(ft.(data_label),1);
    end


function test_eeglab_io()
    datatypes={&#39;timef&#39;,&#39;erp&#39;,&#39;itc&#39;};

    args=cosmo_cartprod({{true,false},...
                         {true,false},...
                         datatypes});


    ncombi=size(args,1);
    for k=1:ncombi
        arg=args(k,:);
        [s,ds,ext]=build_eeglab_dataset_struct(arg{:});

        ds_from_struct=cosmo_meeg_dataset(s);
        assertEqual(ds.samples,ds_from_struct.samples);
        assertEqual(ds,ds_from_struct);

        % store, then read using cosmo_meeg_dataset
        fn=sprintf(&#39;%s.%s&#39;,tempname(),ext);
        save(fn,&#39;-mat&#39;,&#39;-struct&#39;,&#39;s&#39;);
        cleaner=onCleanup(@()delete(fn));

        ds_loaded=cosmo_meeg_dataset(fn);
        assertEqual(ds,ds_loaded);
        clear cleaner;

        s_converted=cosmo_map2meeg(ds,[&#39;-&#39; ext]);
        assertEqual(s,s_converted)

        % store using cosmo_map2meeg, then read
        cosmo_map2meeg(ds,fn);
        cleaner=onCleanup(@()delete(fn));

        s_loaded=load(fn,&#39;-mat&#39;);
        assertEqual(s_loaded,s);
        assertEqual(s,s_loaded);
        clear cleaner;
    end

function test_eeglab_io_trials()
% test with loading a subset of trials
    datatypes={&#39;timef&#39;,&#39;erp&#39;,&#39;itc&#39;};

    args=cosmo_cartprod({{true,false},...
                         {true,false},...
                         datatypes});

    ncombi=size(args,1);
    for k=1:ncombi
        arg=args(k,:);
        [s,ds,ext]=build_eeglab_dataset_struct(arg{:});

        nsamples=size(ds.samples,1);
        trial_idx=ceil(rand(1,2)*nsamples);
        ds_expected_trials=cosmo_slice(ds,trial_idx);

        % with struct input
        ds_trials=cosmo_meeg_dataset(s,&#39;trials&#39;,trial_idx);
        assertElementsAlmostEqual(ds_trials.samples,...
                                ds_expected_trials.samples,...
                                &#39;absolute&#39;,1e-4);

        % store, then read using cosmo_meeg_dataset
        fn=sprintf(&#39;%s.%s&#39;,tempname(),ext);
        save(fn,&#39;-mat&#39;,&#39;-struct&#39;,&#39;s&#39;);
        cleaner=onCleanup(@()delete(fn));

        ds_loaded=cosmo_meeg_dataset(fn,&#39;trials&#39;,trial_idx);
        assertEqual(ds_loaded,ds_expected_trials);


        % test illegal options
        aet=@(varargin)assertExceptionThrown(@()...
                            cosmo_meeg_dataset(varargin{:}),&#39;&#39;);
        illegal_args={nsamples+1,0,struct,{},&#39;foo&#39;,true,1.5};
        for j=1:numel(illegal_args)
            arg=illegal_args{j};
            aet(s,&#39;trials&#39;,arg);
        end

        clear cleaner;
    end

function test_eeglab_io_ersp()
    aet=@(varargin)assertExceptionThrown(@()...
                    cosmo_meeg_dataset(varargin{:}),&#39;&#39;);

    args=cosmo_cartprod({{true,false},...
                         {false},...
                         {&#39;ersp&#39;},...
                         {false,true}});

     ncombi=size(args,1);
    for k=1:ncombi
        arg=args(k,1:3);
        [s,ds_cell,ext]=build_eeglab_dataset_struct(arg{:});

        % either load baseline data or original data
        with_baseline=args{k,4};
        if with_baseline
            load_args={&#39;data_field&#39;,&#39;erspbase&#39;};
            ds=ds_cell{2};
        else
            load_args={&#39;data_field&#39;,&#39;ersp&#39;};
            ds=ds_cell{1};
        end

        % illegal without arguments or wrong arguments
        aet(s);
        aet(s,&#39;data_field&#39;,&#39;foo&#39;);
        aet(s,&#39;data_field&#39;,false);

        % load data with correct arguments
        ds_loaded=cosmo_meeg_dataset(s,load_args{:});
        assertEqual(ds_loaded,ds);


         % store, then read using cosmo_meeg_dataset
        fn=sprintf(&#39;%s.%s&#39;,tempname(),ext);
        save(fn,&#39;-mat&#39;,&#39;-struct&#39;,&#39;s&#39;);
        cleaner=onCleanup(@()delete(fn));

        ds_loaded=cosmo_meeg_dataset(fn,load_args);

        % writing the file is not supported
        assertExceptionThrown(@()cosmo_map2meeg(ds,fn),&#39;&#39;);

        clear cleaner

        assertEqual(ds_loaded,ds);
    end







function test_eeglab_io_exceptions()
    aet_md=@(varargin)assertExceptionThrown(@()...
                            cosmo_meeg_dataset(varargin{:}),&#39;&#39;);
    aet_m2m=@(varargin)assertExceptionThrown(@()...
                            cosmo_map2meeg(varargin{:}),&#39;&#39;);

    s=build_eeglab_dataset_struct(true,true,&#39;timef&#39;);

    % bad datatype
    s.datatype=&#39;foo&#39;;
    aet_md(s)

    % output is not a filename
    ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;timefreq&#39;);
    aet_m2m(ds,struct);

    % bad  fdim
    good_labels={&#39;chan&#39;,&#39;freq&#39;,&#39;time&#39;};
    all_bad_labels={&#39;chan&#39;,&#39;freq&#39;,&#39;time&#39;,&#39;foo&#39;};

    for dim=1:numel(good_labels)
        for j=1:numel(all_bad_labels)
            ds_bad_chan_fdim=ds;
            bad=all_bad_labels{j};
            if ~strcmp(bad, good_labels{dim})
                ds_bad_chan_fdim.a.fdim.labels{dim}=bad;
                aet_m2m(ds_bad_chan_fdim,&#39;-dattimef&#39;);
            end
        end
    end


function [s,ds,ext]=build_eeglab_dataset_struct(has_ica,has_trial,datatype,...
                        chan_dim,freq_dim,time_dim)
    if nargin&lt;6
        time_dim=randint();
    end

    if nargin&lt;5
        freq_dim=randint();
    end

    if nargin&lt;4
        chan_dim=randint();
    end


    % trial dimension
    if has_trial
        trial_dim=randint();
    else
        trial_dim=1;
    end

    if strcmp(datatype,&#39;ersp&#39;)
        % has baseline corrected data together with baseline data
        builder=@build_eeglab_dataset_struct;
        args={chan_dim,freq_dim,time_dim};
        [s1,ds1,ext]=builder(has_ica,has_trial,...
                                &#39;ersp_baselinecorrected&#39;,args{:});
        [s2,ds2]=builder(has_ica,has_trial,...
                                &#39;erspbase&#39;,args{:});

        keys=fieldnames(s1);
        for k=1:numel(keys)
            key=keys{k};
            s2.(key)=s1.(key);
        end

        s=s2;
        s.datatype=upper(datatype);

        % make sure parameters are the same
        ds1.a.meeg.parameters=s.parameters;
        ds2.a.meeg.parameters=s.parameters;

        if isfield(s,&#39;chanlabels&#39;)
            chan_labels=s.chanlabels;
            ds1.a.fdim.values{1}=chan_labels;
            ds2.a.fdim.values{1}=chan_labels;
        end

        ds={ds1,ds2};
        % remove second part from extension
        ext=regexprep(ext,&#39;_.*&#39;,&#39;&#39;);
        return;
    end

    % channel / component dimension
    if has_ica
        chan_prefix=&#39;comp&#39;;
        ext_prefix=&#39;ica&#39;;

        make_chan_prefix_func=@()chan_prefix;
    else
        chan_prefix=&#39;chan&#39;;
        ext_prefix=&#39;dat&#39;;

        make_chan_prefix_func=@randstr;
    end

    has_freq=2;

    switch datatype
        case &#39;timef&#39;
            chan_suffix=&#39;_timef&#39;;

        case &#39;erp&#39;
            chan_suffix=&#39;&#39;;

        case &#39;ersp_baselinecorrected&#39;
            chan_suffix=&#39;_ersp&#39;;

        case &#39;erspbase&#39;
            chan_suffix=&#39;_erspbase&#39;;

        case &#39;itc&#39;;
            chan_suffix=&#39;_itc&#39;;

        otherwise
            assert(false);
    end

    make_chan_label=@(idx) sprintf(&#39;%s%d&#39;,make_chan_prefix_func(),idx);

    chan_label={chan_prefix};
    chan_value={arrayfun(make_chan_label,1:chan_dim,...
                            &#39;UniformOutput&#39;,false)};

    % frequency dimension
    switch datatype
        case {&#39;timef&#39;,&#39;ersp_baselinecorrected&#39;,&#39;itc&#39;,&#39;erspbase&#39;}
            has_freq=true;


        case {&#39;erp&#39;};
            has_freq=false;

        otherwise
            assert(false);
    end

    if has_freq
        freq_label={&#39;freq&#39;};
        freq_value={(1:freq_dim)*2};
        samples_type=&#39;timefreq&#39;;
    else
        freq_dim=[];
        freq_label={};
        freq_value={};
        samples_type=&#39;timelock&#39;;
    end

    ext_suffix=datatype;

    hastime=~strcmp(datatype,&#39;erspbase&#39;);

    if hastime
        % include time dimension
        time_label={&#39;time&#39;};
        time_value={(1:time_dim())*.2-.1};
    else
        % no time dimension
        time_dim=[];
        time_label={};
        time_value={};
    end

    % data
    dim_sizes=[trial_dim,chan_dim,freq_dim,time_dim];
    dim_sizes_without_chan=[dim_sizes([1, 3:end]), 1];
    data_arr=randn(dim_sizes);

    % params
    parameters={randstr(), randstr()};

    % make dataset
    ds=cosmo_flatten(data_arr,...
                        [chan_label,freq_label,time_label],...
                        [chan_value,freq_value,time_value]);
    ds.sa=struct();
    ds.a.meeg.samples_field=&#39;trial&#39;;
    ds.a.meeg.samples_type=samples_type;
    ds.a.meeg.samples_label=&#39;rpt&#39;;
    ds.a.meeg.parameters=parameters;


    s=struct();
    for k=1:chan_dim
        key=sprintf(&#39;%s%d%s&#39;,chan_prefix,k,chan_suffix);
        value=data_arr(:,k,:);
        value_rs=reshape(value,dim_sizes_without_chan);

        if has_freq
            % it seems that for freq data, single trial data is the last
            % dimension, whereas for erp data, single trial data is the first
            % dimension.
            value_rs=shiftdim(value_rs,1);
        end

        s.(key)=value_rs;
    end

    if ~has_ica
        s.chanlabels=chan_value{1};
        assert(iscellstr(s.chanlabels));
    end

    if has_freq
        s.freqs=freq_value{1};
    end

    if hastime
        s.times=time_value{1};
    end

    s.datatype=upper(ext_suffix);
    s.parameters=parameters;

    ext=[ext_prefix, ext_suffix];


function test_dimord_label()
    opt=struct();
    opt.samples_label={&#39;&#39;,&#39;rpt&#39;,&#39;trial&#39;};
    opt.nsamples={1,randint(),10};
    opt.datatype={&#39;timefreq&#39;,&#39;timelock&#39;};

    combis=cosmo_cartprod(opt);
    n_combi=numel(combis);

    for k=1:n_combi
        c=combis{k};

        ds=cosmo_synthetic_dataset(&#39;type&#39;,c.datatype,...
                                        &#39;ntargets&#39;,1,...
                                        &#39;nchunks&#39;,c.nsamples,...
                                    &#39;size&#39;,&#39;big&#39;);
        assertEqual(size(ds.samples,1),c.nsamples);

        with_samples_label=~isempty(c.samples_label);
        if with_samples_label
            ds.a.meeg.samples_label=c.samples_label;
        else
            ds.a.meeg=rmfield(ds.a.meeg,&#39;samples_label&#39;);
        end

        data_is_average=c.nsamples==1 &amp;&amp; ~with_samples_label;

        switch c.datatype
            case &#39;timefreq&#39;
                samples_field=&#39;powspctrm&#39;;

            case &#39;timelock&#39;
                if data_is_average
                    samples_field=&#39;avg&#39;;
                else
                    samples_field=&#39;trial&#39;;
                end

            otherwise
                assert(false)
        end


        ft=cosmo_map2meeg(ds);

        labels=cosmo_strsplit(ft.dimord,&#39;_&#39;);

        ndim_expected=numel(ds.a.fdim.labels);
        if ~data_is_average
            ndim_expected=ndim_expected+1;
        end

        assertEqual(numel(labels),ndim_expected);
        assertEqual(numel(size(ft.(samples_field))),ndim_expected);

    end



function x=randint()
    x=ceil(rand()*10+5);

function x=randstr()
    x=char(rand(1,10)*24+65);
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cosmomvpa_logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="test_meeg_find_layout.html"
                        title="previous chapter">test meeg find layout</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="test_meeg_layout_collection.html"
                        title="next chapter">test meeg layout collection</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/matlab/test_meeg_io.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="test_meeg_layout_collection.html" title="test meeg layout collection"
             >next</a> |</li>
        <li class="right" >
          <a href="test_meeg_find_layout.html" title="test meeg find layout"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_test.html" >CoSMoMVPA unit tests</a> &#187;</li> 
      </ul>
    </div>
      <div class="footer">
       <span class="creativecommons">
          <a href="http://opensource.org/licenses/MIT" >
          <img src="../_static/mit-license_logo.png"
               border="0" alt="Creative Commons License"/>
         </a> 
         
        <a href="copyright.html">Copyright 2013-2016 Nikolaas N. Oosterhof, Andrew C. Connolly, CoSMoMVPA contributors</a>.
        CoSMoMVPA is licensed under a <a href="http://opensource.org/licenses/MIT">Expat (MIT) License</a>.
       </span>
      </div>
  </body>
</html>