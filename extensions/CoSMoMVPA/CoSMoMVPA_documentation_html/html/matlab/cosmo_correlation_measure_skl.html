    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cosmo correlation measure skl &#8212; CoSMo Multivariate Pattern Analysis toolbox 1.0rc1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0rc1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="cosmo cross neighborhood skl" href="cosmo_cross_neighborhood_skl.html" />
    <link rel="prev" title="cosmo corr skl" href="cosmo_corr_skl.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cosmo_cross_neighborhood_skl.html" title="cosmo cross neighborhood skl"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cosmo_corr_skl.html" title="cosmo corr skl"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_skl.html" accesskey="U">CoSMoMVPA functions - skeleton files</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cosmo-correlation-measure-skl">
<span id="id1"></span><h1>cosmo correlation measure skl<a class="headerlink" href="#cosmo-correlation-measure-skl" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>ds_sa<span class="p">=</span><span class="nf">cosmo_correlation_measure</span><span class="p">(</span>ds, varargin<span class="p">)</span><span class="w"></span>
<span class="c">% Computes a split-half correlation measure</span>
<span class="c">%</span>
<span class="c">% d=cosmo_correlation_measure(ds[, args])</span>
<span class="c">%</span>
<span class="c">% Inputs:</span>
<span class="c">%  ds             dataset structure with fields .samples, .sa.targets and</span>
<span class="c">%                 .sa.chunks</span>
<span class="c">%  args           optional struct with the following optional fields:</span>
<span class="c">%    .partitions  struct with fields .train_indices and .test_indices.</span>
<span class="c">%                 Both should be a Px1 cell for P partitions. If omitted,</span>
<span class="c">%                 it is set to cosmo_nchoosek_partitioner(ds,&#39;half&#39;).</span>
<span class="c">%    .template    QxQ matrix for Q classes in each chunk. This matrix</span>
<span class="c">%                 weights the correlations across the two halves.</span>
<span class="c">%                 If ds.sa.targets has only one unique value, it must be</span>
<span class="c">%                 set to the scalar value 1; otherwise it should</span>
<span class="c">%                 have a mean of zero. If omitted, it has positive values</span>
<span class="c">%                 of (1/Q) on the diagonal and (-1/(Q*(Q-1)) off the</span>
<span class="c">%                 diagonal.</span>
<span class="c">%                 (Note: this can be used to test for representational</span>
<span class="c">%                 similarity matching)</span>
<span class="c">%    .merge_func  A function handle used to merge data from matching</span>
<span class="c">%                 targets in the same chunk. Default is @(x) mean(x,1),</span>
<span class="c">%                 meaning that values are averaged over the same samples.</span>
<span class="c">%                 It is assumed that isequal(args.merge_func(y),y) if y</span>
<span class="c">%                 is a row vector.</span>
<span class="c">%    .corr_type   Type of correlation: &#39;Pearson&#39;,&#39;Spearman&#39;,&#39;Kendall&#39;.</span>
<span class="c">%                 The default is &#39;Pearson&#39;.</span>
<span class="c">%    .post_corr_func  Operation performed after correlation. (default:</span>
<span class="c">%                     @atanh)</span>
<span class="c">%    .output      &#39;mean&#39; (default): correlations weighted by template</span>
<span class="c">%                 &#39;raw&#39; or &#39;correlation&#39;: correlations between all classes</span>
<span class="c">%                 &#39;one_minus_correlation&#39;: 1 minus correlations</span>
<span class="c">%                 &#39;mean_by_fold&#39;: provide weighted correlations for each</span>
<span class="c">%                                 fold in the partitions.</span>
<span class="c">%</span>
<span class="c">%</span>
<span class="c">% Output:</span>
<span class="c">%    ds_sa        Struct with fields:</span>
<span class="c">%      .samples   Scalar indicating how well the template matrix</span>
<span class="c">%                 correlates with the correlation matrix from the two</span>
<span class="c">%                 halves (averaged over partitions). By default:</span>
<span class="c">%                 - this value is based on Fisher-transformed correlation</span>
<span class="c">%                   values, not raw correlation values</span>
<span class="c">%                 - this is the average of the (Fisher-transformed)</span>
<span class="c">%                   on-diagonal minus the average of the</span>
<span class="c">%                   (Fisher-transformed) off-diagonal elements of the</span>
<span class="c">%                   correlation matrix based on the two halves of the data.</span>
<span class="c">%      .sa        Struct with field:</span>
<span class="c">%        .labels  if output==&#39;corr&#39;</span>
<span class="c">%        .half1   } if output==&#39;raw&#39;: (N^2)x1 vectors with indices of data</span>
<span class="c">%        .half2   } from two halves, with N the number of unique targets.</span>
<span class="c">%</span>
<span class="c">% Example:</span>
<span class="c">%     ds=cosmo_synthetic_dataset();</span>
<span class="c">%     %</span>
<span class="c">%     % compute on-minus-off diagonal correlations</span>
<span class="c">%     c=cosmo_correlation_measure(ds);</span>
<span class="c">%     cosmo_disp(c)</span>
<span class="c">%     &gt; .samples</span>
<span class="c">%     &gt;   [ 1.23 ]</span>
<span class="c">%     &gt; .sa</span>
<span class="c">%     &gt;   .labels</span>
<span class="c">%     &gt;   { &#39;corr&#39; }</span>
<span class="c">%     %</span>
<span class="c">%     % use Spearman correlations</span>
<span class="c">%     c=cosmo_correlation_measure(ds,&#39;corr_type&#39;,&#39;Spearman&#39;);</span>
<span class="c">%     cosmo_disp(c)</span>
<span class="c">%     &gt; .samples</span>
<span class="c">%     &gt;   [ 1.28 ]</span>
<span class="c">%     &gt; .sa</span>
<span class="c">%     &gt;   .labels</span>
<span class="c">%     &gt;   { &#39;corr&#39; }</span>
<span class="c">%     %</span>
<span class="c">%     % get raw output</span>
<span class="c">%     c_raw=cosmo_correlation_measure(ds,&#39;output&#39;,&#39;correlation&#39;);</span>
<span class="c">%     cosmo_disp(c_raw)</span>
<span class="c">%     &gt; .samples</span>
<span class="c">%     &gt;   [  0.447</span>
<span class="c">%     &gt;     -0.538</span>
<span class="c">%     &gt;     -0.525</span>
<span class="c">%     &gt;      0.959 ]</span>
<span class="c">%     &gt; .sa</span>
<span class="c">%     &gt;   .half1</span>
<span class="c">%     &gt;     [ 1</span>
<span class="c">%     &gt;       2</span>
<span class="c">%     &gt;       1</span>
<span class="c">%     &gt;       2 ]</span>
<span class="c">%     &gt;   .half2</span>
<span class="c">%     &gt;     [ 1</span>
<span class="c">%     &gt;       1</span>
<span class="c">%     &gt;       2</span>
<span class="c">%     &gt;       2 ]</span>
<span class="c">%     &gt; .a</span>
<span class="c">%     &gt;   .sdim</span>
<span class="c">%     &gt;     .labels</span>
<span class="c">%     &gt;       { &#39;half1&#39;  &#39;half2&#39; }</span>
<span class="c">%     &gt;     .values</span>
<span class="c">%     &gt;       { [ 1    [ 1</span>
<span class="c">%     &gt;           2 ]    2 ] }</span>
<span class="c">%     %</span>
<span class="c">%     % convert to matrix form (N x N x P, with N the number of classes and</span>
<span class="c">%     % P=1)</span>
<span class="c">%     matrices=cosmo_unflatten(c_raw,1);</span>
<span class="c">%     cosmo_disp(matrices)</span>
<span class="c">%     &gt; [  0.447    -0.525</span>
<span class="c">%     &gt;   -0.538     0.959 ]</span>
<span class="c">%</span>
<span class="c">%     % compute for each fold separately, using a custom take-one-chunk</span>
<span class="c">%     % out partitioning scheme. c.sa.chunks in the output</span>
<span class="c">%     % reflects the test chunk in each partition</span>
<span class="c">%     ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;fmri&#39;,&#39;nchunks&#39;,4);</span>
<span class="c">%     partitions=cosmo_nfold_partitioner(ds);</span>
<span class="c">%     c=cosmo_correlation_measure(ds,&#39;output&#39;,&#39;mean_by_fold&#39;,...</span>
<span class="c">%                         &#39;partitions&#39;,partitions);</span>
<span class="c">%     cosmo_disp(c.samples);</span>
<span class="c">%     &gt; [  1.72</span>
<span class="c">%     &gt;   0.728</span>
<span class="c">%     &gt;    1.25</span>
<span class="c">%     &gt;    2.02 ]</span>
<span class="c">%     cosmo_disp(c.sa);</span>
<span class="c">%     &gt; .partition</span>
<span class="c">%     &gt;   [ 1</span>
<span class="c">%     &gt;     2</span>
<span class="c">%     &gt;     3</span>
<span class="c">%     &gt;     4 ]</span>
<span class="c">%</span>
<span class="c">%     % minimal searchlight example</span>
<span class="c">%     ds=cosmo_synthetic_dataset(&#39;type&#39;,&#39;fmri&#39;);</span>
<span class="c">%     % use searchlight with radius 1 voxel (radius=3 is more typical)</span>
<span class="c">%     nbrhood=cosmo_spherical_neighborhood(ds,&#39;radius&#39;,1,&#39;progress&#39;,false);</span>
<span class="c">%     % run searchlight</span>
<span class="c">%     res=cosmo_searchlight(ds,nbrhood,@cosmo_correlation_measure,...</span>
<span class="c">%                               &#39;progress&#39;,false);</span>
<span class="c">%     cosmo_disp(res.samples)</span>
<span class="c">%     &gt; [ 1.87      1.25      1.51      1.68      1.71     0.879 ]</span>
<span class="c">%     cosmo_disp(res.sa)</span>
<span class="c">%     &gt; .labels</span>
<span class="c">%     &gt;   { &#39;corr&#39; }</span>
<span class="c">%</span>
<span class="c">% Notes:</span>
<span class="c">%   - by default the post_corr_func is set to @atanh. This is equivalent to</span>
<span class="c">%     a Fisher transformation from r (correlation) to z (standard z-score).</span>
<span class="c">%     The underlying math is z=atanh(r)=.5*log((1+r)./log(1-r)).</span>
<span class="c">%     The rationale is to make data more normally distributed under the</span>
<span class="c">%     null hypothesis.</span>
<span class="c">%     Fisher-transformed correlations can be transformed back to</span>
<span class="c">%     their original correlation values using &#39;tanh&#39;, which is the inverse</span>
<span class="c">%     of &#39;atanh&#39;.</span>
<span class="c">%   - To disable the (by default used) Fisher-transformation, set the</span>
<span class="c">%     &#39;post_corr_func&#39; option to [].</span>
<span class="c">%   - if multiple samples are present with the same chunk and target, they</span>
<span class="c">%     are averaged *prior* to computing the correlations.</span>
<span class="c">%   - if multiple partitions are present, then the correlations are</span>
<span class="c">%     computed separately for each partition, and then averaged (unless</span>
<span class="c">%     the &#39;output&#39; option is set, and set to a different value than</span>
<span class="c">%     &#39;mean&#39;.</span>
<span class="c">%   - When more than two chunks are present in the input, partitions</span>
<span class="c">%     consist of all possible half splits for which the number of unique</span>
<span class="c">%     chunks in the train and test set differ by 1 at most.</span>
<span class="c">%     For illustration, up to 6 chunks, the</span>
<span class="c">%     partitions are:</span>
<span class="c">%       - 2 chunks   -  partition #1</span>
<span class="c">%         chunks first  half: {    1</span>
<span class="c">%         chunks second half:  {   2</span>
<span class="c">%</span>
<span class="c">%       - 3 chunks   -  partition #1  #2  #3</span>
<span class="c">%         chunks first  half: {    3   2   1</span>
<span class="c">%                              {   1   1   2</span>
<span class="c">%         chunks second half:  {   2   3   3</span>
<span class="c">%</span>
<span class="c">%       - 4 chunks   -  partition #1  #2  #3</span>
<span class="c">%                             {    3   2   2</span>
<span class="c">%         chunks first  half: {    4   4   3</span>
<span class="c">%                              {   1   1   1</span>
<span class="c">%         chunks second half:  {   2   3   4</span>
<span class="c">%</span>
<span class="c">%       - 5 chunks   -  partition #1  #2  #3  #4  #5  #6  #7  #8  #9  #10</span>
<span class="c">%                             {    4   3   3   2   2   2   1   1   1   1</span>
<span class="c">%         chunks first  half: {    5   5   4   5   4   3   5   4   3   2</span>
<span class="c">%                              {   1   1   1   1   1   1   2   2   2   3</span>
<span class="c">%         chunks second half:  {   2   2   2   3   3   4   3   3   4   4</span>
<span class="c">%                              {   3   4   5   4   5   5   4   5   5   5</span>
<span class="c">%</span>
<span class="c">%       - 6 chunks   -  partition #1  #2  #3  #4  #5  #6  #7  #8  #9  #10</span>
<span class="c">%                             {    4   3   3   3   2   2   2   2   2   2</span>
<span class="c">%         chunks first  half: {    5   5   4   4   5   4   4   3   3   3</span>
<span class="c">%                             {    6   6   6   5   6   6   5   6   5   4</span>
<span class="c">%                              {   1   1   1   1   1   1   1   1   1   1</span>
<span class="c">%         chunks second half:  {   2   2   2   2   3   3   3   4   4   5</span>
<span class="c">%                              {   3   4   5   6   4   5   6   5   6   6</span>
<span class="c">%     Thus, with an increasing number of chunks, the number of partitions</span>
<span class="c">%     (and thus the time required to run this function) increases</span>
<span class="c">%     quadratically. To use simpler partition schemes (e.g. odd-even, as</span>
<span class="c">%     provided by cosmo_oddeven_partitioner), specify the &#39;partitions&#39;</span>
<span class="c">%     argument.</span>
<span class="c">%</span>
<span class="c">% References</span>
<span class="c">%   - Haxby, J. V. et al (2001). Distributed and overlapping</span>
<span class="c">%     representations of faces and objects in ventral temporal cortex.</span>
<span class="c">%     Science 293, 2425?2430</span>
<span class="c">%</span>
<span class="c">% #   For CoSMoMVPA&#39;s copyright information and license terms,   #</span>
<span class="c">% #   see the COPYING file distributed with CoSMoMVPA.           #</span>

<span class="k">persistent</span> <span class="n">cached_partitions</span><span class="p">;</span>
<span class="k">persistent</span> <span class="n">cached_chunks</span><span class="p">;</span>
<span class="k">persistent</span> <span class="n">cached_params</span><span class="p">;</span>
<span class="k">persistent</span> <span class="n">cached_varargin</span><span class="p">;</span>

<span class="c">% optimize parameters parsing: if same arguments were used in</span>
<span class="c">% a previous call, do not use cosmo_structjoin (which is relative</span>
<span class="c">% expensive)</span>
<span class="k">if</span> <span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">cached_params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">isequal</span><span class="p">(</span><span class="n">cached_varargin</span><span class="p">,</span> <span class="n">varargin</span><span class="p">)</span>
    <span class="n">params</span><span class="p">=</span><span class="n">cached_params</span><span class="p">;</span>
<span class="k">else</span>
    <span class="n">defaults</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">partitions</span><span class="p">=[];</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">template</span><span class="p">=[];</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">merge_func</span><span class="p">=[];</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">corr_type</span><span class="p">=</span><span class="s">&#39;Pearson&#39;</span><span class="p">;</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">post_corr_func</span><span class="p">=@</span><span class="nb">atanh</span><span class="p">;</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">output</span><span class="p">=</span><span class="s">&#39;mean&#39;</span><span class="p">;</span>
    <span class="n">defaults</span><span class="p">.</span><span class="n">check_partitions</span><span class="p">=</span><span class="n">true</span><span class="p">;</span>

    <span class="n">params</span><span class="p">=</span><span class="n">cosmo_structjoin</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="n">varargin</span><span class="p">);</span>

    <span class="n">cached_params</span><span class="p">=</span><span class="n">params</span><span class="p">;</span>
    <span class="n">cached_varargin</span><span class="p">=</span><span class="n">varargin</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">partitions</span><span class="p">=</span><span class="n">params</span><span class="p">.</span><span class="n">partitions</span><span class="p">;</span>
<span class="n">template</span><span class="p">=</span><span class="n">params</span><span class="p">.</span><span class="n">template</span><span class="p">;</span>
<span class="n">merge_func</span><span class="p">=</span><span class="n">params</span><span class="p">.</span><span class="n">merge_func</span><span class="p">;</span>
<span class="n">post_corr_func</span><span class="p">=</span><span class="n">params</span><span class="p">.</span><span class="n">post_corr_func</span><span class="p">;</span>
<span class="n">check_partitions</span><span class="p">=</span><span class="n">params</span><span class="p">.</span><span class="n">check_partitions</span><span class="p">;</span>

<span class="n">chunks</span><span class="p">=</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">chunks</span><span class="p">;</span>

<span class="k">if</span> <span class="nb">isempty</span><span class="p">(</span><span class="n">partitions</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">cached_chunks</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">isequal</span><span class="p">(</span><span class="n">cached_chunks</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
        <span class="n">partitions</span><span class="p">=</span><span class="n">cached_partitions</span><span class="p">;</span>

        <span class="c">% assume that partitions were already checked</span>
        <span class="n">check_partitions</span><span class="p">=</span><span class="n">false</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">partitions</span><span class="p">=</span><span class="n">cosmo_nchoosek_partitioner</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;half&#39;</span><span class="p">);</span>
        <span class="n">cached_chunks</span><span class="p">=</span><span class="n">chunks</span><span class="p">;</span>
        <span class="n">cached_partitions</span><span class="p">=</span><span class="n">partitions</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">check_partitions</span>
    <span class="n">cosmo_check_partitions</span><span class="p">(</span><span class="n">partitions</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="k">end</span>

<span class="n">targets</span><span class="p">=</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">targets</span><span class="p">;</span>
<span class="n">nsamples</span><span class="p">=</span><span class="nb">size</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="p">[</span><span class="n">classes</span><span class="p">,</span><span class="n">unused</span><span class="p">,</span><span class="n">class_ids</span><span class="p">]=</span><span class="n">fast_unique</span><span class="p">(</span><span class="n">targets</span><span class="p">);</span>
<span class="n">nclasses</span><span class="p">=</span><span class="nb">numel</span><span class="p">(</span><span class="n">classes</span><span class="p">);</span>

<span class="k">switch</span> <span class="n">nclasses</span>
    <span class="k">case</span> <span class="mi">0</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&#39;No classes found - this is not supported&#39;</span><span class="p">);</span>
    <span class="k">case</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="o">~</span><span class="nb">isequal</span><span class="p">(</span><span class="n">template</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">error</span><span class="p">([</span> <span class="s">&#39;Only one unique value for .sa.targets was found; &#39;</span><span class="c">...</span>
                    <span class="s">&#39;this is only allowed when the &#39;&#39;template&#39;&#39; &#39;</span><span class="c">...</span>
                    <span class="s">&#39;parameter is explicitly set to 1.\n&#39;</span><span class="c">...</span>
                    <span class="s">&#39;Note that this option does not compute the &#39;</span><span class="c">...</span>
                    <span class="s">&#39;correlation *difference* between matching and &#39;</span><span class="c">...</span>
                    <span class="s">&#39;non-matching values in .sa.targets; instead it &#39;</span><span class="c">...</span>
                    <span class="s">&#39;computes the direct correlation &#39;</span><span class="c">...</span>
                    <span class="s">&#39;between two halves of the data. A typical use &#39;</span><span class="c">...</span>
                    <span class="s">&#39;case is when .samples already contains a &#39;</span><span class="c">...</span>
                    <span class="s">&#39;difference score  comparing two different &#39;</span><span class="c">...</span>
                    <span class="s">&#39;conditions&#39;</span><span class="p">]);</span>
        <span class="k">end</span>
    <span class="k">otherwise</span>
        <span class="k">if</span> <span class="nb">isempty</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="n">template</span><span class="p">=(</span><span class="nb">eye</span><span class="p">(</span><span class="n">nclasses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">nclasses</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nclasses</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">max_tolerance</span><span class="p">=</span><span class="mf">1e-8</span><span class="p">;</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">template</span><span class="p">(:)))</span><span class="o">&gt;</span><span class="n">max_tolerance</span>
                <span class="n">error</span><span class="p">(</span><span class="s">&#39;Template matrix does not have a sum of zero&#39;</span><span class="p">);</span>
            <span class="k">end</span>
        <span class="k">end</span>
<span class="k">end</span>


<span class="n">template_msk</span><span class="p">=</span><span class="nb">isfinite</span><span class="p">(</span><span class="n">template</span><span class="p">);</span>

<span class="n">npartitions</span><span class="p">=</span><span class="nb">numel</span><span class="p">(</span><span class="n">partitions</span><span class="p">.</span><span class="n">train_indices</span><span class="p">);</span>

<span class="c">% space for output</span>
<span class="n">pdata</span><span class="p">=</span><span class="n">cell</span><span class="p">(</span><span class="n">npartitions</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="c">% keep track of how often each chunk was used in test_indices,</span>
<span class="c">% and which chunk was used last</span>
<span class="n">test_chunks_last</span><span class="p">=</span><span class="n">NaN</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">test_chunks_count</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="n">nsamples</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="k">for</span> <span class="n">k</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">npartitions</span>
    <span class="n">train_indices</span><span class="p">=</span><span class="n">partitions</span><span class="p">.</span><span class="n">train_indices</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
    <span class="n">test_indices</span><span class="p">=</span><span class="n">partitions</span><span class="p">.</span><span class="n">test_indices</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>

    <span class="c">% get data in each half</span>
    <span class="n">half1</span><span class="p">=</span><span class="n">get_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">train_indices</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">merge_func</span><span class="p">);</span>
    <span class="n">half2</span><span class="p">=</span><span class="n">get_data</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">test_indices</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">merge_func</span><span class="p">);</span>

    <span class="c">% compute raw correlations</span>
    <span class="n">raw_c</span><span class="p">=</span><span class="n">cosmo_corr</span><span class="p">(</span><span class="n">half1</span><span class="o">&#39;</span><span class="p">,</span> <span class="n">half2</span><span class="o">&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">corr_type</span><span class="p">);</span>

    <span class="c">% apply post-processing (usually Fisher-transform, i.e. atanh)</span>
    <span class="n">c</span><span class="p">=</span><span class="n">apply_post_corr_func</span><span class="p">(</span><span class="n">post_corr_func</span><span class="p">,</span><span class="n">raw_c</span><span class="p">);</span>

    <span class="c">% aggregate results</span>
    <span class="n">pdata</span><span class="p">{</span><span class="n">k</span><span class="p">}=</span><span class="n">aggregate_correlations</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">template</span><span class="p">,</span><span class="n">template_msk</span><span class="p">,</span><span class="n">params</span><span class="p">.</span><span class="n">output</span><span class="p">);</span>
    <span class="n">test_chunks_last</span><span class="p">(</span><span class="n">test_indices</span><span class="p">)=</span><span class="n">chunks</span><span class="p">(</span><span class="n">test_indices</span><span class="p">);</span>
    <span class="n">test_chunks_count</span><span class="p">(</span><span class="n">test_indices</span><span class="p">)=</span><span class="n">test_chunks_count</span><span class="p">(</span><span class="n">test_indices</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">ds_sa</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>

<span class="k">switch</span> <span class="n">params</span><span class="p">.</span><span class="n">output</span>
    <span class="k">case</span> <span class="s">&#39;mean&#39;</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="p">=</span><span class="n">mean</span><span class="p">(</span><span class="nb">cat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">pdata</span><span class="p">{:}),</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">labels</span><span class="p">={</span><span class="s">&#39;corr&#39;</span><span class="p">};</span>
    <span class="k">case</span> <span class="p">{</span><span class="s">&#39;raw&#39;</span><span class="p">,</span><span class="s">&#39;correlation&#39;</span><span class="p">}</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="p">=</span><span class="n">mean</span><span class="p">(</span><span class="nb">cat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">pdata</span><span class="p">{:}),</span><span class="mi">2</span><span class="p">);</span>

        <span class="n">nclasses</span><span class="p">=</span><span class="nb">numel</span><span class="p">(</span><span class="n">classes</span><span class="p">);</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">half1</span><span class="p">=</span><span class="nb">reshape</span><span class="p">(</span><span class="nb">repmat</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">nclasses</span><span class="p">)</span><span class="o">&#39;</span><span class="p">,</span><span class="n">nclasses</span><span class="p">,</span><span class="mi">1</span><span class="p">),[],</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">half2</span><span class="p">=</span><span class="nb">reshape</span><span class="p">(</span><span class="nb">repmat</span><span class="p">((</span><span class="mi">1</span><span class="p">:</span><span class="n">nclasses</span><span class="p">),</span><span class="n">nclasses</span><span class="p">,</span><span class="mi">1</span><span class="p">),[],</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">ds_sa</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">sdim</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">sdim</span><span class="p">.</span><span class="n">labels</span><span class="p">={</span><span class="s">&#39;half1&#39;</span><span class="p">,</span><span class="s">&#39;half2&#39;</span><span class="p">};</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">sdim</span><span class="p">.</span><span class="n">values</span><span class="p">={</span><span class="n">classes</span><span class="p">,</span> <span class="n">classes</span><span class="p">};</span>

    <span class="k">case</span> <span class="s">&#39;mean_by_fold&#39;</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">partition</span><span class="p">=(</span><span class="mi">1</span><span class="p">:</span><span class="n">npartitions</span><span class="p">)</span><span class="o">&#39;</span><span class="p">;</span>
        <span class="n">ds_sa</span><span class="p">.</span><span class="n">samples</span><span class="p">=[</span><span class="n">pdata</span><span class="p">{:}]</span><span class="o">&#39;</span><span class="p">;</span>

    <span class="k">otherwise</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">false</span><span class="p">,</span><span class="s">&#39;this should be caught by get_data&#39;</span><span class="p">);</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span>c<span class="p">=</span><span class="nf">apply_post_corr_func</span><span class="p">(</span>post_corr_func,c<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">post_corr_func</span><span class="p">)</span>
        <span class="n">c</span><span class="p">=</span><span class="n">post_corr_func</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">end</span>


<span class="k">function</span><span class="w"> </span>agg_c<span class="p">=</span><span class="nf">aggregate_correlations</span><span class="p">(</span>c,template,template_msk,output<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span> <span class="n">output</span>
        <span class="k">case</span> <span class="p">{</span><span class="s">&#39;mean&#39;</span><span class="p">,</span><span class="s">&#39;mean_by_fold&#39;</span><span class="p">}</span>
            <span class="n">pcw</span><span class="p">=</span><span class="n">c</span><span class="p">(</span><span class="n">template_msk</span><span class="p">)</span><span class="o">.*</span><span class="n">template</span><span class="p">(</span><span class="n">template_msk</span><span class="p">);</span>
            <span class="n">agg_c</span><span class="p">=</span><span class="n">sum</span><span class="p">(</span><span class="n">pcw</span><span class="p">(:));</span>
        <span class="k">case</span> <span class="p">{</span><span class="s">&#39;raw&#39;</span><span class="p">,</span><span class="s">&#39;correlation&#39;</span><span class="p">}</span>
            <span class="n">agg_c</span><span class="p">=</span><span class="n">c</span><span class="p">(:);</span>
        <span class="k">case</span> <span class="s">&#39;one_minus_correlation&#39;</span>
            <span class="n">error</span><span class="p">([</span><span class="s">&#39;the &#39;&#39;output&#39;&#39; option &#39;&#39;one_minus_correlation&#39;&#39; &#39;</span><span class="c">...</span>
                        <span class="s">&#39;has been removed. Please contact CoSMoMVPA&#39;&#39;s &#39;</span><span class="c">...</span>
                        <span class="s">&#39;authors if you really need this option&#39;</span><span class="p">]);</span>
        <span class="k">otherwise</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;Unsupported output %s&#39;</span><span class="p">,</span><span class="n">output</span><span class="p">);</span>
    <span class="k">end</span>

<span class="k">function</span><span class="w"> </span>[unq,pos,ids]<span class="p">=</span><span class="nf">fast_unique</span><span class="p">(</span>x<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c">% optimized for vectors</span>
    <span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="nb">i</span><span class="p">]=</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">msk</span><span class="p">=[</span><span class="n">true</span><span class="p">;</span><span class="n">diff</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">];</span>
    <span class="nb">j</span><span class="p">=</span><span class="nb">find</span><span class="p">(</span><span class="n">msk</span><span class="p">);</span>
    <span class="n">pos</span><span class="p">=</span><span class="nb">i</span><span class="p">(</span><span class="nb">j</span><span class="p">);</span>
    <span class="n">unq</span><span class="p">=</span><span class="n">y</span><span class="p">(</span><span class="nb">j</span><span class="p">);</span>

    <span class="n">vs</span><span class="p">=</span><span class="n">cumsum</span><span class="p">(</span><span class="n">msk</span><span class="p">);</span>
    <span class="n">ids</span><span class="p">=</span><span class="n">vs</span><span class="p">;</span>
    <span class="n">ids</span><span class="p">(</span><span class="nb">i</span><span class="p">)=</span><span class="n">vs</span><span class="p">;</span>


<span class="k">function</span><span class="w"> </span>data<span class="p">=</span><span class="nf">get_data</span><span class="p">(</span>ds, sample_idxs, class_ids, merge_func<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">samples</span><span class="p">=</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(</span><span class="n">sample_idxs</span><span class="p">,:);</span>
    <span class="n">target_ids</span><span class="p">=</span><span class="n">class_ids</span><span class="p">(</span><span class="n">sample_idxs</span><span class="p">);</span>

    <span class="n">nclasses</span><span class="p">=</span><span class="n">max</span><span class="p">(</span><span class="n">class_ids</span><span class="p">);</span>

    <span class="n">merge_by_averaging</span><span class="p">=</span><span class="nb">isempty</span><span class="p">(</span><span class="n">merge_func</span><span class="p">);</span>
    <span class="k">if</span> <span class="nb">isequal</span><span class="p">(</span><span class="n">target_ids</span><span class="o">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nclasses</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">merge_by_averaging</span>
        <span class="c">% optimize standard case of one sample per class and normal</span>
        <span class="c">% averaging over samples</span>
        <span class="n">data</span><span class="p">=</span><span class="n">samples</span><span class="p">;</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="n">nfeatures</span><span class="p">=</span><span class="nb">size</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="n">nclasses</span><span class="p">,</span><span class="n">nfeatures</span><span class="p">);</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">nclasses</span>
        <span class="n">msk</span><span class="p">=</span><span class="n">target_ids</span><span class="o">==</span><span class="n">k</span><span class="p">;</span>

        <span class="n">n</span><span class="p">=</span><span class="n">sum</span><span class="p">(</span><span class="n">msk</span><span class="p">);</span>

        <span class="n">class_samples</span><span class="p">=</span><span class="n">samples</span><span class="p">(</span><span class="n">msk</span><span class="p">,:);</span>

        <span class="k">if</span> <span class="n">merge_by_averaging</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span>
                <span class="n">data</span><span class="p">(</span><span class="n">k</span><span class="p">,:)=</span><span class="n">class_samples</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">data</span><span class="p">(</span><span class="n">k</span><span class="p">,:)=</span><span class="n">sum</span><span class="p">(</span><span class="n">class_samples</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
            <span class="k">end</span>
        <span class="k">else</span>
            <span class="n">data</span><span class="p">(</span><span class="n">k</span><span class="p">,:)=</span><span class="n">merge_func</span><span class="p">(</span><span class="n">class_samples</span><span class="p">);</span>
        <span class="k">end</span>

        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;missing target class %d&#39;</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
        <span class="k">end</span>
    <span class="k">end</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cosmomvpa_logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="cosmo_corr_skl.html"
                        title="previous chapter">cosmo corr skl</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cosmo_cross_neighborhood_skl.html"
                        title="next chapter">cosmo cross neighborhood skl</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/matlab/cosmo_correlation_measure_skl.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cosmo_cross_neighborhood_skl.html" title="cosmo cross neighborhood skl"
             >next</a> |</li>
        <li class="right" >
          <a href="cosmo_corr_skl.html" title="cosmo corr skl"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_skl.html" >CoSMoMVPA functions - skeleton files</a> &#187;</li> 
      </ul>
    </div>
      <div class="footer">
       <span class="creativecommons">
          <a href="http://opensource.org/licenses/MIT" >
          <img src="../_static/mit-license_logo.png"
               border="0" alt="Creative Commons License"/>
         </a> 
         
        <a href="copyright.html">Copyright 2013-2016 Nikolaas N. Oosterhof, Andrew C. Connolly, CoSMoMVPA contributors</a>.
        CoSMoMVPA is licensed under a <a href="http://opensource.org/licenses/MIT">Expat (MIT) License</a>.
       </span>
      </div>
  </body>
</html>