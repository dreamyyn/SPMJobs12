    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>test fmri dataset &#8212; CoSMo Multivariate Pattern Analysis toolbox 1.0rc1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0rc1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="test fmri deoblique" href="test_fmri_deoblique.html" />
    <link rel="prev" title="test fmri convert xform" href="test_fmri_convert_xform.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="test_fmri_deoblique.html" title="test fmri deoblique"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="test_fmri_convert_xform.html" title="test fmri convert xform"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_test.html" accesskey="U">CoSMoMVPA unit tests</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="test-fmri-dataset">
<span id="id1"></span><h1>test fmri dataset<a class="headerlink" href="#test-fmri-dataset" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-matlab"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span>test_suite <span class="p">=</span><span class="w"> </span><span class="nf">test_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="c">% tests for cosmo_fmri_dataset</span>
<span class="c">%</span>
<span class="c">% #   For CoSMoMVPA&#39;s copyright information and license terms,   #</span>
<span class="c">% #   see the COPYING file distributed with CoSMoMVPA.           #</span>
    <span class="k">try</span> <span class="c">% assignment of &#39;localfunctions&#39; is necessary in Matlab &gt;= 2016</span>
        <span class="n">test_functions</span><span class="p">=</span><span class="n">localfunctions</span><span class="p">();</span>
    <span class="k">catch</span> <span class="c">% no problem; early Matlab versions can use initTestSuite fine</span>
    <span class="k">end</span>
    <span class="n">initTestSuite</span><span class="p">;</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_base_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">get_expected_dataset</span><span class="p">());</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_afni_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="n">cosmo_skip_test_if_no_external</span><span class="p">(</span><span class="s">&#39;afni&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">afni</span><span class="p">=</span><span class="n">cosmo_map2fmri</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;-afni&#39;</span><span class="p">);</span>
    <span class="n">afni_expected</span><span class="p">=</span><span class="n">get_expected_afni</span><span class="p">();</span>

    <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">afni</span><span class="p">.</span><span class="n">img</span><span class="p">,</span> <span class="n">afni_expected</span><span class="p">.</span><span class="n">img</span><span class="p">);</span>
    <span class="n">afni_no_img</span><span class="p">=</span><span class="n">rmfield</span><span class="p">(</span><span class="n">afni</span><span class="p">,</span><span class="s">&#39;img&#39;</span><span class="p">);</span>
    <span class="n">afni_expected_no_img</span><span class="p">=</span><span class="n">rmfield</span><span class="p">(</span><span class="n">afni_expected</span><span class="p">,</span><span class="s">&#39;img&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">afni_no_img</span><span class="p">,</span><span class="n">afni_expected_no_img</span><span class="p">);</span>

    <span class="n">ds_afni</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">afni</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_afni</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_sform_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">cosmo_map2fmri</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;-nii&#39;</span><span class="p">);</span>
    <span class="n">nii_expected</span><span class="p">=</span><span class="n">get_expected_nii_sform</span><span class="p">();</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="n">nii_expected</span><span class="p">.</span><span class="n">hdr</span><span class="p">);</span>
    <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">,</span><span class="n">nii_expected</span><span class="p">.</span><span class="n">img</span><span class="p">);</span>
    <span class="n">ds_nii</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_qform_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_qform</span><span class="p">();</span>
    <span class="n">ds_nii</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>

    <span class="c">% check qform with illegal pixdims</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">pixdim</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)=</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_b</span><span class="p">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_c</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_d</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">ds_nii_alt</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">m</span><span class="p">=</span><span class="n">ds_nii_alt</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">;</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="nb">diag</span><span class="p">(</span><span class="n">m</span><span class="p">),[</span><span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">]</span><span class="o">&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">),[</span><span class="o">-</span><span class="mi">2</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_pixdim_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_pixdim</span><span class="p">();</span>
    <span class="n">ds_nii</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">ds_nii</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">(:,</span><span class="mi">4</span><span class="p">)=</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">(:,</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>

    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">scl_inter</span><span class="p">=</span><span class="mi">200</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">scl_slope</span><span class="p">=</span><span class="mi">17</span><span class="p">;</span>

    <span class="n">ds_nii_scl</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">assertElementsAlmostEqual</span><span class="p">(</span><span class="mi">17</span><span class="o">*</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="o">+</span><span class="mi">200</span><span class="p">,</span><span class="n">ds_nii_scl</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="c">...</span>
                                    <span class="s">&#39;absolute&#39;</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_sform_afni_5d_singleton_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_sform</span><span class="p">();</span>

    <span class="c">% header: move 4th to 5th dimension</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">6</span><span class="p">)=</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">5</span><span class="p">)=</span><span class="mi">1</span><span class="p">;</span>

    <span class="c">% data: move 4th to 5th dimension</span>
    <span class="n">orig_size</span><span class="p">=</span><span class="nb">size</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">);</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">,[</span><span class="n">orig_size</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="mi">1</span> <span class="n">orig_size</span><span class="p">(</span><span class="mi">4</span><span class="p">)]);</span>

    <span class="c">% test this test: verify size is ok</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="nb">size</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">));</span>

    <span class="n">ds_nii</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_sform_afni_5d_nonsingleton_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_sform</span><span class="p">();</span>

    <span class="c">% header: add extra dimension</span>
    <span class="n">nrep</span><span class="p">=</span><span class="nb">ceil</span><span class="p">(</span><span class="nb">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">6</span><span class="p">)=</span><span class="n">nrep</span><span class="p">;</span>

    <span class="c">% data: move 4th to 5th dimension</span>
    <span class="n">img_rep</span><span class="p">=</span><span class="nb">repmat</span><span class="p">({</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">},</span><span class="mi">1</span><span class="p">,</span><span class="n">nrep</span><span class="p">);</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">=</span><span class="nb">cat</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">img_rep</span><span class="p">{:});</span>

    <span class="c">% test this test: verify size is ok</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="nb">size</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">));</span>

    <span class="c">% must not support this</span>
    <span class="n">assertExceptionThrown</span><span class="p">(@()</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">),</span><span class="s">&#39;&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_nii_sform_and_qform_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_sform_and_qform</span><span class="p">();</span>
    <span class="n">ds_nii</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>

    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_x</span><span class="p">(</span><span class="mi">1</span><span class="p">)=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">assertExceptionThrown</span><span class="p">(@()</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">),</span><span class="s">&#39;&#39;</span><span class="p">);</span>
    <span class="n">ds_nii_qform</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span><span class="s">&#39;nifti_form&#39;</span><span class="p">,</span><span class="s">&#39;qform&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">ds_nii_qform</span><span class="p">,</span><span class="n">ds_nii</span><span class="p">);</span>
    <span class="n">assertExceptionThrown</span><span class="p">(@()</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">nii</span><span class="p">,</span><span class="s">&#39;nifti_form&#39;</span><span class="p">,</span><span class="s">&#39;X&#39;</span><span class="p">),</span><span class="s">&#39;&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_bv_vmr_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="n">can_test_bv</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">end</span>
    <span class="n">uint_ds</span><span class="p">=</span><span class="n">get_uint8_dataset</span><span class="p">();</span>
    <span class="n">bv_vmr</span><span class="p">=</span><span class="n">cosmo_map2fmri</span><span class="p">(</span><span class="n">uint_ds</span><span class="p">,</span><span class="s">&#39;-bv_vmr&#39;</span><span class="p">);</span>

    <span class="n">cleaner</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">bv_vmr</span><span class="p">.</span><span class="n">ClearObject</span><span class="p">());</span>
    <span class="n">neuroelf_bless_wrapper</span><span class="p">(</span><span class="n">bv_vmr</span><span class="p">);</span>

    <span class="n">assert_bv_equal</span><span class="p">(</span><span class="n">bv_vmr</span><span class="p">,</span> <span class="n">get_expected_bv_vmr</span><span class="p">());</span>
    <span class="n">ds_bv_vmr</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">bv_vmr</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">false</span><span class="p">);</span>
    <span class="n">ds_bv_vmr_lpi</span><span class="p">=</span><span class="n">cosmo_fmri_reorient</span><span class="p">(</span><span class="n">ds_bv_vmr</span><span class="p">,</span><span class="s">&#39;LPI&#39;</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">uint_ds</span><span class="p">,</span><span class="n">ds_bv_vmr_lpi</span><span class="p">,</span><span class="s">&#39;rotation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_bv_vmp_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="n">can_test_bv</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">bv_vmp</span><span class="p">=</span><span class="n">cosmo_map2fmri</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;-bv_vmp&#39;</span><span class="p">);</span>

    <span class="n">cleaner</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">bv_vmp</span><span class="p">.</span><span class="n">ClearObject</span><span class="p">());</span>
    <span class="n">neuroelf_bless_wrapper</span><span class="p">(</span><span class="n">bv_vmp</span><span class="p">);</span>

    <span class="n">assert_bv_equal</span><span class="p">(</span><span class="n">bv_vmp</span><span class="p">,</span> <span class="n">get_expected_bv_vmp</span><span class="p">());</span>
    <span class="n">ds_bv_vmp</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">bv_vmp</span><span class="p">);</span>
    <span class="n">ds_bv_vmp_lpi</span><span class="p">=</span><span class="n">cosmo_fmri_reorient</span><span class="p">(</span><span class="n">ds_bv_vmp</span><span class="p">,</span><span class="s">&#39;LPI&#39;</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_bv_vmp_lpi</span><span class="p">,</span><span class="s">&#39;translation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_bv_msk_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="n">can_test_bv</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="n">uint_ds</span><span class="p">=</span><span class="n">get_uint8_dataset</span><span class="p">();</span>
    <span class="n">bv_msk</span><span class="p">=</span><span class="n">cosmo_map2fmri</span><span class="p">(</span><span class="n">uint_ds</span><span class="p">,</span><span class="s">&#39;-bv_msk&#39;</span><span class="p">);</span>

    <span class="n">cleaner</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">bv_msk</span><span class="p">.</span><span class="n">ClearObject</span><span class="p">());</span>
    <span class="n">neuroelf_bless_wrapper</span><span class="p">(</span><span class="n">bv_msk</span><span class="p">);</span>

    <span class="n">assert_bv_equal</span><span class="p">(</span><span class="n">bv_msk</span><span class="p">,</span> <span class="n">get_expected_bv_msk</span><span class="p">());</span>

    <span class="n">ds_bv_msk</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">bv_msk</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">false</span><span class="p">);</span>
    <span class="n">ds_bv_msk_lpi</span><span class="p">=</span><span class="n">cosmo_fmri_reorient</span><span class="p">(</span><span class="n">ds_bv_msk</span><span class="p">,</span><span class="s">&#39;LPI&#39;</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">uint_ds</span><span class="p">,</span><span class="n">ds_bv_msk_lpi</span><span class="p">,</span><span class="s">&#39;translation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_bv_vtc_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="n">can_test_bv</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">=</span><span class="nb">round</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">xff_bv_vtc</span><span class="p">=</span><span class="n">get_expected_xff_bv_vtc</span><span class="p">();</span>
    <span class="n">cleaner</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">ClearObject</span><span class="p">());</span>
    <span class="n">neuroelf_bless_wrapper</span><span class="p">(</span><span class="n">xff_bv_vtc</span><span class="p">);</span>

    <span class="n">ds_bv_vtc</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">xff_bv_vtc</span><span class="p">);</span>
    <span class="n">ds_bv_glm_lpi</span><span class="p">=</span><span class="n">cosmo_fmri_reorient</span><span class="p">(</span><span class="n">ds_bv_vtc</span><span class="p">,</span><span class="s">&#39;LPI&#39;</span><span class="p">);</span>

    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_bv_glm_lpi</span><span class="p">,</span><span class="s">&#39;translation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_bv_glm_subject_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="o">~</span><span class="n">can_test_bv</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">end</span>

    <span class="c">% no support for map2fmri, so just test with neuroelf struct</span>
    <span class="n">ds</span><span class="p">=</span><span class="n">get_base_dataset</span><span class="p">();</span>

    <span class="n">xff_bv_glm</span><span class="p">=</span><span class="n">get_expected_xff_bv_glm</span><span class="p">();</span>
    <span class="n">cleaner</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">ClearObject</span><span class="p">());</span>
    <span class="n">neuroelf_bless_wrapper</span><span class="p">(</span><span class="n">xff_bv_glm</span><span class="p">);</span>

    <span class="n">ds_bv_glm</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">xff_bv_glm</span><span class="p">);</span>
    <span class="n">ds_bv_glm_lpi</span><span class="p">=</span><span class="n">cosmo_fmri_reorient</span><span class="p">(</span><span class="n">ds_bv_glm</span><span class="p">,</span><span class="s">&#39;LPI&#39;</span><span class="p">);</span>

    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">ds_bv_glm_lpi</span><span class="p">,</span><span class="s">&#39;translation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_mask_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">aet</span><span class="p">=@(</span><span class="n">varargin</span><span class="p">)</span><span class="n">assertExceptionThrown</span><span class="p">(@()</span><span class="c">...</span>
                        <span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">varargin</span><span class="p">{:}),</span><span class="s">&#39;&#39;</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(:,[</span><span class="mi">2</span> <span class="mi">6</span><span class="p">])=</span><span class="mi">0</span><span class="p">;</span>

    <span class="n">x</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;-auto&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">],</span><span class="mi">2</span><span class="p">));</span>
    <span class="n">x1</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">true</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
    <span class="n">x2</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">false</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">ds</span><span class="p">);</span>


    <span class="n">aet</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;foo&#39;</span><span class="p">);</span>
    <span class="n">aet</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;-foo&#39;</span><span class="p">);</span>
    <span class="n">aet</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">ds</span><span class="p">);</span>
    <span class="n">aet</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">struct</span><span class="p">);</span>

    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">aet</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;-auto&#39;</span><span class="p">);</span>

    <span class="n">x3</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;-any&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>

    <span class="n">x4</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="s">&#39;-all&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x4</span><span class="p">,</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">],</span><span class="mi">2</span><span class="p">));</span>

    <span class="n">msk_ds</span><span class="p">=</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">randperm</span><span class="p">(</span><span class="nb">size</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">x5</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">msk_ds</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x5</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_pymvpa_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">pymvpa_ds</span><span class="p">=</span><span class="n">get_pymvpa_dataset</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">pymvpa_ds</span><span class="p">);</span>
    <span class="n">assert_dataset_equal</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">get_expected_dataset</span><span class="p">(),</span> <span class="s">&#39;translation&#39;</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_pymvpa_3d_string_array</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">py_ds</span><span class="p">=</span><span class="n">get_pymvpa_dataset</span><span class="p">();</span>

    <span class="n">sa_labels</span><span class="p">={</span><span class="s">&#39;foo&#39;</span><span class="p">;</span><span class="s">&#39;bar&#39;</span><span class="p">};</span>
    <span class="n">sa_labels_3d</span><span class="p">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">strvcat</span><span class="p">(</span><span class="n">sa_labels</span><span class="p">),[</span><span class="mi">2</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="n">py_ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">labels</span><span class="p">=</span><span class="n">sa_labels_3d</span><span class="p">;</span>

    <span class="n">fa_labels</span><span class="p">={</span><span class="s">&#39;foox&#39;</span><span class="p">,</span><span class="s">&#39;barx&#39;</span><span class="p">,</span><span class="s">&#39;foobazx&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">,</span><span class="s">&#39;3&#39;</span><span class="p">};</span>
    <span class="n">fa_labels_3d</span><span class="p">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">strvcat</span><span class="p">(</span><span class="n">fa_labels</span><span class="p">),[</span><span class="mi">1</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">]);</span>
    <span class="n">py_ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="n">labels</span><span class="p">=</span><span class="n">fa_labels_3d</span><span class="p">;</span>

    <span class="n">ds</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">py_ds</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span><span class="n">sa_labels</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="n">labels</span><span class="p">,</span><span class="n">fa_labels</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">test_meeg_source_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;source&#39;</span><span class="p">);</span>
    <span class="n">res</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span><span class="n">res</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="nb">diag</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">),[</span><span class="mi">10</span> <span class="mi">10</span> <span class="mi">10</span> <span class="mi">1</span><span class="p">]</span><span class="o">&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_set_sa_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">();</span>
    <span class="n">res</span><span class="p">=</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;targets&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="s">&#39;chunks&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">targets</span><span class="p">,(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">&#39;</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">chunks</span><span class="p">,</span><span class="nb">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>

    <span class="n">assertExceptionThrown</span><span class="p">(@()</span><span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;targets&#39;</span><span class="p">,[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">]),</span><span class="s">&#39;&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span><span class="nf">test_nan_warning_fmri_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">(</span><span class="mi">1</span><span class="p">)=</span><span class="n">NaN</span><span class="p">;</span>
    <span class="n">msk_ds</span><span class="p">=</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">orig_warning_state</span><span class="p">=</span><span class="n">cosmo_warning</span><span class="p">();</span>
    <span class="n">warning_state_resetter</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">cosmo_warning</span><span class="p">(</span><span class="n">orig_warning_state</span><span class="p">));</span>
    <span class="n">cosmo_warning</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">);</span>

    <span class="n">cosmo_fmri_dataset</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="s">&#39;mask&#39;</span><span class="p">,</span><span class="n">msk_ds</span><span class="p">);</span>
    <span class="n">warning_state</span><span class="p">=</span><span class="n">cosmo_warning</span><span class="p">();</span>

    <span class="n">warning_pos</span><span class="p">=</span><span class="n">strmatch</span><span class="p">(</span><span class="s">&#39;The input dataset has NaN&#39;</span><span class="p">,</span><span class="c">...</span>
                    <span class="n">warning_state</span><span class="p">.</span><span class="n">shown_warnings</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">~</span><span class="nb">isempty</span><span class="p">(</span><span class="n">warning_pos</span><span class="p">));</span>


<span class="k">function</span><span class="w"> </span>tf<span class="p">=</span><span class="nf">can_test_bv</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">tf</span><span class="p">=</span><span class="o">~</span><span class="n">cosmo_skip_test_if_no_external</span><span class="p">(</span><span class="s">&#39;neuroelf&#39;</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>ds<span class="p">=</span><span class="nf">get_base_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">(</span><span class="s">&#39;ntargets&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">&#39;nchunks&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>ds<span class="p">=</span><span class="nf">get_uint8_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">(</span><span class="s">&#39;ntargets&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">&#39;nchunks&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">=</span><span class="n">cosmo_slice</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">mn</span><span class="p">=</span><span class="n">min</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
    <span class="n">mx</span><span class="p">=</span><span class="n">max</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">=</span><span class="n">uint8</span><span class="p">((</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="o">-</span><span class="n">mn</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mx</span><span class="o">-</span><span class="n">mn</span><span class="p">)</span><span class="o">*</span><span class="mi">255</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>ds<span class="p">=</span><span class="nf">get_pymvpa_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">cosmo_synthetic_dataset</span><span class="p">(</span><span class="s">&#39;ntargets&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s">&#39;nchunks&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

    <span class="c">% set .a</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">imgaffine</span><span class="p">=</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">;</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">imgaffine</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)=</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">imgaffine</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="c">...</span>
                        <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">imgaffine</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">voxel_eldim</span><span class="p">=</span><span class="n">single</span><span class="p">([</span><span class="mi">3</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">voxel_dim</span><span class="p">=</span><span class="n">int64</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">(:));</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">=</span><span class="n">rmfield</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;vol&#39;</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">=</span><span class="n">rmfield</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="s">&#39;fdim&#39;</span><span class="p">);</span>

    <span class="c">% set .fa</span>
    <span class="n">voxel_indices</span><span class="p">=</span><span class="n">int64</span><span class="p">([</span><span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="nb">i</span><span class="p">;</span> <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="nb">j</span><span class="p">;</span> <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="n">voxel_indices</span><span class="p">=</span><span class="n">voxel_indices</span><span class="p">;</span>

    <span class="c">% set .samples</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">=</span><span class="n">single</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>



<span class="k">function</span><span class="w"> </span><span class="nf">assertAlmostEqualWithTol</span><span class="p">(</span>x,y<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">assertElementsAlmostEqual</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">double</span><span class="p">(</span><span class="n">y</span><span class="p">),</span><span class="s">&#39;relative&#39;</span><span class="p">,</span><span class="mf">1e-3</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span><span class="nf">assert_dataset_equal</span><span class="p">(</span>x,y,opt<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span> <span class="n">nargin</span><span class="o">&lt;</span><span class="mi">3</span> <span class="o">||</span> <span class="nb">isempty</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="n">opt</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="k">end</span>
    <span class="c">% dataset equality, without .sa</span>
    <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
    <span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">fa</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">fa</span><span class="p">)</span>

    <span class="k">switch</span> <span class="n">opt</span>
        <span class="k">case</span> <span class="s">&#39;rotation&#39;</span>
            <span class="c">% BV VMR cannot store orientation, just check the rotation part</span>
            <span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">);</span>
            <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">);</span>
            <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="c">...</span>
                            <span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">));</span>
        <span class="k">case</span> <span class="s">&#39;translation&#39;</span>
            <span class="c">% BV VMP or PyMVPA cannot store xform, just check the matrix</span>
            <span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">);</span>
            <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">);</span>
            <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">,</span><span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">);</span>
        <span class="k">otherwise</span>
            <span class="n">assertEqual</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">.</span><span class="n">a</span><span class="p">)</span>
    <span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="nf">assert_bv_equal</span><span class="p">(</span>x_xff, y_struct<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c">% BV equality; first argument is xff class, second argument a struct</span>
    <span class="c">% passes if all fields in y_struct have the same value in x_xff;</span>
    <span class="c">% x_xff can have more fields than y_struct</span>
    <span class="n">keys</span><span class="p">=</span><span class="n">fieldnames</span><span class="p">(</span><span class="n">y_struct</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">key</span><span class="p">=</span><span class="n">keys</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
        <span class="n">y</span><span class="p">=</span><span class="n">y_struct</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
        <span class="n">x</span><span class="p">=</span><span class="n">x_xff</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">isstruct</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">j</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">assert_bv_equal</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="nb">j</span><span class="p">),</span><span class="n">y</span><span class="p">(</span><span class="nb">j</span><span class="p">))</span>
            <span class="k">end</span>
        <span class="k">else</span>
            <span class="n">assertAlmostEqualWithTol</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
        <span class="k">end</span>

    <span class="k">end</span>

<span class="k">function</span><span class="w"> </span>xff_bv_glm<span class="p">=</span><span class="nf">get_expected_xff_bv_glm</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">xff_bv_glm</span><span class="p">=</span><span class="n">xff</span><span class="p">(</span><span class="s">&#39;new:glm&#39;</span><span class="p">);</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">NrOfSubjects</span><span class="p">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">NrOfPredictors</span><span class="p">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">Predictor</span><span class="p">=</span><span class="n">struct</span><span class="p">(</span><span class="s">&#39;Name1&#39;</span><span class="p">,{</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">},</span><span class="c">...</span>
                                <span class="s">&#39;Name2&#39;</span><span class="p">,{</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;2&#39;</span><span class="p">},</span><span class="c">...</span>
                                <span class="s">&#39;RGB&#39;</span><span class="p">,{[</span><span class="mi">255</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">255</span> <span class="mi">0</span><span class="p">]});</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">Resolution</span><span class="p">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">XStart</span> <span class="p">=</span> <span class="mi">127</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">XEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">YStart</span> <span class="p">=</span> <span class="mi">129</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">YEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">ZStart</span> <span class="p">=</span> <span class="mi">125</span><span class="p">;</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">ZEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>

    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">data_size</span><span class="p">=</span><span class="nb">size</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">mat_size</span><span class="p">=</span><span class="n">data_size</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,:,</span><span class="mi">1</span><span class="p">)=</span><span class="nb">reshape</span><span class="p">([</span> <span class="o">-</span><span class="mf">0.2040</span>   <span class="o">-</span><span class="mf">1.0504</span>   <span class="o">-</span><span class="mf">0.2617</span> <span class="c">...</span>
                            <span class="o">-</span><span class="mf">3.6849</span>    <span class="mf">1.3494</span>    <span class="mf">2.0317</span><span class="p">],</span> <span class="n">mat_size</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,:,</span><span class="mi">2</span><span class="p">)=</span><span class="nb">reshape</span><span class="p">([</span><span class="mf">0.4823</span> <span class="o">-</span><span class="mf">1.3265</span> <span class="mf">2.3387</span> <span class="c">...</span>
                            <span class="mf">1.7235</span> <span class="o">-</span><span class="mf">0.3973</span> <span class="mf">0.5838</span><span class="p">],</span> <span class="n">mat_size</span><span class="p">);</span>
    <span class="n">xff_bv_glm</span><span class="p">.</span><span class="n">GLMData</span><span class="p">.</span><span class="n">BetaMaps</span><span class="p">=</span><span class="n">data</span><span class="p">;</span>

<span class="k">function</span><span class="w"> </span>xff_bv_vtc<span class="p">=</span><span class="nf">get_expected_xff_bv_vtc</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">xff_bv_vtc</span><span class="p">=</span><span class="n">xff</span><span class="p">(</span><span class="s">&#39;new:vtc&#39;</span><span class="p">);</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">NrOfVolumes</span><span class="p">=</span><span class="mi">2</span><span class="p">;</span>

    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">Resolution</span><span class="p">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">XStart</span> <span class="p">=</span> <span class="mi">127</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">XEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">YStart</span> <span class="p">=</span> <span class="mi">129</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">YEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">ZStart</span> <span class="p">=</span> <span class="mi">125</span><span class="p">;</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">ZEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>

    <span class="n">data_orig</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">data_size</span><span class="p">=</span><span class="nb">size</span><span class="p">(</span><span class="n">data_orig</span><span class="p">);</span>
    <span class="n">mat_size</span><span class="p">=</span><span class="n">data_size</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">data_orig</span><span class="p">(:,:,:,</span><span class="mi">1</span><span class="p">)=</span><span class="nb">reshape</span><span class="p">([</span> <span class="o">-</span><span class="mf">0.2040</span>   <span class="o">-</span><span class="mf">1.0504</span>   <span class="o">-</span><span class="mf">0.2617</span> <span class="c">...</span>
                            <span class="o">-</span><span class="mf">3.6849</span>    <span class="mf">1.3494</span>    <span class="mf">2.0317</span><span class="p">],</span> <span class="n">mat_size</span><span class="p">);</span>
    <span class="n">data_orig</span><span class="p">(:,:,:,</span><span class="mi">2</span><span class="p">)=</span><span class="nb">reshape</span><span class="p">([</span><span class="mf">0.4823</span> <span class="o">-</span><span class="mf">1.3265</span> <span class="mf">2.3387</span> <span class="c">...</span>
                            <span class="mf">1.7235</span> <span class="o">-</span><span class="mf">0.3973</span> <span class="mf">0.5838</span><span class="p">],</span> <span class="n">mat_size</span><span class="p">);</span>

    <span class="n">data</span><span class="p">=</span><span class="n">uint16</span><span class="p">(</span><span class="n">data_orig</span><span class="p">);</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">VTCData</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;uint16&#39;</span><span class="p">);</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">VTCData</span><span class="p">(</span><span class="mi">1</span><span class="p">,:,:,:)=</span><span class="n">data</span><span class="p">(:,:,:,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">xff_bv_vtc</span><span class="p">.</span><span class="n">VTCData</span><span class="p">(</span><span class="mi">2</span><span class="p">,:,:,:)=</span><span class="n">data</span><span class="p">(:,:,:,</span><span class="mi">2</span><span class="p">);</span>


<span class="k">function</span><span class="w"> </span>bv_msk<span class="p">=</span><span class="nf">get_expected_bv_msk</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">bv_msk</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">Resolution</span><span class="p">=</span> <span class="mi">2</span> <span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">XStart</span> <span class="p">=</span> <span class="mi">127</span><span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">XEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">YStart</span> <span class="p">=</span> <span class="mi">129</span><span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">YEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">ZStart</span> <span class="p">=</span> <span class="mi">125</span><span class="p">;</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">ZEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>

    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;uint8&#39;</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">155</span> <span class="mi">118</span> <span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">2</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">153</span> <span class="mi">0</span> <span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">3</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">225</span> <span class="mi">255</span> <span class="p">];</span>
    <span class="n">bv_msk</span><span class="p">.</span><span class="n">Mask</span><span class="p">=</span><span class="n">data</span><span class="p">;</span>

<span class="k">function</span><span class="w"> </span>bv_vmp<span class="p">=</span><span class="nf">get_expected_bv_vmp</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">bv_vmp</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">NrOfMaps</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">OverallMapType</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">OverallNrOfLags</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">NrOfTimePoints</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">NrOfMapParameters</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">ShowParamsRangeFrom</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">ShowParamsRangeTo</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">FingerprintParamsRangeFrom</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">FingerprintParamsRangeTo</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">Resolution</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">XStart</span> <span class="p">=</span> <span class="mi">127</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">XEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">YStart</span> <span class="p">=</span> <span class="mi">129</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">YEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">ZStart</span> <span class="p">=</span> <span class="mi">125</span><span class="p">;</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">ZEnd</span> <span class="p">=</span> <span class="mi">131</span><span class="p">;</span>

    <span class="n">map1</span><span class="p">.</span><span class="n">VMPData</span><span class="p">=</span><span class="nb">reshape</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2040</span>   <span class="o">-</span><span class="mf">1.0504</span>   <span class="o">-</span><span class="mf">0.2617</span>   <span class="c">...</span>
                            <span class="o">-</span><span class="mf">3.6849</span>    <span class="mf">1.3494</span>    <span class="mf">2.0317</span><span class="p">],[</span><span class="mi">2</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="n">map2</span><span class="p">.</span><span class="n">VMPData</span><span class="p">=</span><span class="nb">reshape</span><span class="p">([</span><span class="mf">0.4823</span> <span class="o">-</span><span class="mf">1.3265</span> <span class="mf">2.3387</span> <span class="c">...</span>
                            <span class="mf">1.7235</span> <span class="o">-</span><span class="mf">0.3973</span> <span class="mf">0.5838</span><span class="p">],[</span><span class="mi">2</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">]);</span>
    <span class="n">bv_vmp</span><span class="p">.</span><span class="n">Map</span><span class="p">=</span><span class="nb">cat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">map1</span><span class="p">,</span><span class="n">map2</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>bv_vmr<span class="p">=</span><span class="nf">get_expected_bv_vmr</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="n">bv_vmr</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">FileVersion</span> <span class="p">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">DimX</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">DimY</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">DimZ</span> <span class="p">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VMRData16</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">OffsetX</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">OffsetY</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">OffsetZ</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">FramingCube</span> <span class="p">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">PosInfoVerified</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">RowDirX</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">RowDirY</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">RowDirZ</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">ColDirX</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">ColDirY</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">ColDirZ</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">NRows</span> <span class="p">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">NCols</span> <span class="p">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">FoVRows</span> <span class="p">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">FoVCols</span> <span class="p">=</span> <span class="mi">256</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">SliceThickness</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">GapThickness</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">ReferenceSpace</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VoxResX</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VoxResY</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VoxResZ</span> <span class="p">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VoxResInTalairach</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VoxResVerified</span> <span class="p">=</span> <span class="n">false</span><span class="p">;</span>

    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">&#39;uint8&#39;</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">155</span> <span class="mi">118</span> <span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">2</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">153</span> <span class="mi">0</span> <span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">3</span><span class="p">)</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">225</span> <span class="mi">255</span> <span class="p">];</span>
    <span class="n">bv_vmr</span><span class="p">.</span><span class="n">VMRData</span><span class="p">=</span><span class="n">data</span><span class="p">;</span>



<span class="k">function</span><span class="w"> </span>afni<span class="p">=</span><span class="nf">get_expected_afni</span><span class="p">()</span><span class="w"></span>

<span class="w">    </span><span class="c">% header</span>
    <span class="n">afni</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">SCENE_DATA</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">11</span> <span class="mi">1</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">TYPESTRING</span> <span class="p">=</span> <span class="s">&#39;3DIM_HEAD_FUNC&#39;</span> <span class="p">;</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_TYPES</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">3</span> <span class="mi">3</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_STATS</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_FLOAT_FACS</span> <span class="p">=</span> <span class="p">[</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">DATASET_RANK</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">3</span> <span class="mi">2</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">DATASET_DIMENSIONS</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">3</span> <span class="mi">2</span> <span class="mi">1</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">ORIENT_SPECIFIC</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">4</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">DELTA</span> <span class="p">=</span> <span class="p">[</span> <span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="mi">2</span> <span class="mi">2</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">ORIGIN</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">1</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">SCALE</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_LABS</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_KEYWORDS</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BRICK_STATAUX</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">STAT_AUX</span> <span class="p">=</span> <span class="p">[];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">SCALE</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">NOTES_COUNT</span><span class="p">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">WARP_TYPE</span><span class="p">=[</span><span class="mi">0</span> <span class="mi">0</span><span class="p">];</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">FileFormat</span><span class="p">=</span><span class="s">&#39;BRIK&#39;</span><span class="p">;</span>
    <span class="p">[</span><span class="n">unused</span><span class="p">,</span> <span class="n">unused</span><span class="p">,</span> <span class="n">endian_ness</span><span class="p">]</span> <span class="p">=</span> <span class="n">computer</span><span class="p">();</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">BYTEORDER_STRING</span> <span class="p">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="s">&#39;%sSB_FIRST&#39;</span><span class="p">,</span><span class="n">endian_ness</span> <span class="p">);</span>

    <span class="c">% data</span>
    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)=[</span> <span class="mf">2.0317</span>    <span class="mf">1.3494</span><span class="p">;</span><span class="o">-</span><span class="mf">3.6849</span>   <span class="o">-</span><span class="mf">0.2617</span><span class="p">;</span><span class="o">-</span><span class="mf">1.0504</span>   <span class="o">-</span><span class="mf">0.2040</span><span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)=[</span> <span class="mf">0.5838</span>   <span class="o">-</span><span class="mf">0.3973</span><span class="p">;</span> <span class="mf">1.7235</span>    <span class="mf">2.3387</span><span class="p">;</span><span class="o">-</span><span class="mf">1.3265</span>    <span class="mf">0.4823</span><span class="p">];</span>

    <span class="c">% add to image</span>
    <span class="n">afni</span><span class="p">.</span><span class="n">img</span><span class="p">=</span><span class="n">data</span><span class="p">;</span>

<span class="k">function</span><span class="w"> </span>ds<span class="p">=</span><span class="nf">get_expected_dataset</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">ds</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">samples</span><span class="p">=[</span> <span class="mf">2.0317</span>   <span class="o">-</span><span class="mf">3.6849</span>   <span class="o">-</span><span class="mf">1.0504</span>    <span class="mf">1.3494</span>   <span class="o">-</span><span class="mf">0.2617</span>   <span class="o">-</span><span class="mf">0.2040</span><span class="p">;</span>
                 <span class="mf">0.5838</span>    <span class="mf">1.7235</span>   <span class="o">-</span><span class="mf">1.3265</span>   <span class="o">-</span><span class="mf">0.3973</span>    <span class="mf">2.3387</span>    <span class="mf">0.4823</span><span class="p">];</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="nb">i</span><span class="p">=[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">];</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="nb">j</span><span class="p">=[</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">2</span><span class="p">];</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">fa</span><span class="p">.</span><span class="n">k</span><span class="p">=[</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">.</span><span class="n">labels</span><span class="p">={</span><span class="s">&#39;i&#39;</span><span class="p">;</span><span class="s">&#39;j&#39;</span><span class="p">;</span><span class="s">&#39;k&#39;</span><span class="p">};</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">fdim</span><span class="p">.</span><span class="n">values</span><span class="p">={[</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">];[</span><span class="mi">1</span> <span class="mi">2</span><span class="p">];</span><span class="mi">1</span><span class="p">};</span>
    <span class="n">mat</span><span class="p">=</span><span class="nb">diag</span><span class="p">([</span><span class="mi">2</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">]);</span>
    <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)=</span><span class="o">-</span><span class="mi">3</span><span class="p">;</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">mat</span><span class="p">=</span><span class="n">mat</span><span class="p">;</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">dim</span><span class="p">=[</span><span class="mi">3</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">ds</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">vol</span><span class="p">.</span><span class="n">xform</span><span class="p">=</span><span class="s">&#39;scanner_anat&#39;</span><span class="p">;</span>


<span class="k">function</span><span class="w"> </span>nii<span class="p">=</span><span class="nf">get_expected_nii_pixdim</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_helper</span><span class="p">();</span>
    <span class="n">fields_to_clear</span><span class="p">={</span><span class="s">&#39;quatern_b&#39;</span><span class="p">,</span><span class="s">&#39;quatern_c&#39;</span><span class="p">,</span><span class="s">&#39;quatern_d&#39;</span><span class="p">,</span><span class="c">...</span>
                        <span class="s">&#39;qoffset_x&#39;</span><span class="p">,</span><span class="s">&#39;qoffset_y&#39;</span><span class="p">,</span><span class="s">&#39;qoffset_z&#39;</span><span class="p">,</span><span class="c">...</span>
                        <span class="s">&#39;srow_x&#39;</span><span class="p">,</span><span class="s">&#39;srow_y&#39;</span><span class="p">,</span><span class="s">&#39;srow_z&#39;</span><span class="p">};</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">=</span><span class="n">clear_fields</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">,</span><span class="n">fields_to_clear</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>nii<span class="p">=</span><span class="nf">get_expected_nii_sform_and_qform</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_helper</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">sform_code</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qform_code</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">function</span><span class="w"> </span>nii<span class="p">=</span><span class="nf">get_expected_nii_sform</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_helper</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">sform_code</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">fields_to_clear</span><span class="p">={</span><span class="s">&#39;quatern_b&#39;</span><span class="p">,</span><span class="s">&#39;quatern_c&#39;</span><span class="p">,</span><span class="s">&#39;quatern_d&#39;</span><span class="p">,</span><span class="c">...</span>
                        <span class="s">&#39;qoffset_x&#39;</span><span class="p">,</span><span class="s">&#39;qoffset_y&#39;</span><span class="p">,</span><span class="s">&#39;qoffset_z&#39;</span><span class="p">};</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">=</span><span class="n">clear_fields</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">,</span><span class="n">fields_to_clear</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>nii<span class="p">=</span><span class="nf">get_expected_nii_qform</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">nii</span><span class="p">=</span><span class="n">get_expected_nii_helper</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qform_code</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">fields_to_clear</span><span class="p">={</span><span class="s">&#39;srow_x&#39;</span><span class="p">,</span><span class="s">&#39;srow_y&#39;</span><span class="p">,</span><span class="s">&#39;srow_z&#39;</span><span class="p">};</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">=</span><span class="n">clear_fields</span><span class="p">(</span><span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">,</span><span class="n">fields_to_clear</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>nii<span class="p">=</span><span class="nf">get_expected_nii_helper</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">hdr</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">datatype</span> <span class="p">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">dim</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">4</span> <span class="mi">3</span> <span class="mi">2</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="p">];</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">pixdim</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="p">];</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">intent_p1</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">intent_p2</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">intent_p3</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">intent_code</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">slice_start</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">slice_duration</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">slice_end</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">scl_slope</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">scl_inter</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">slice_code</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">cal_max</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">cal_min</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">toffset</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">dime</span><span class="p">.</span><span class="n">xyzt_units</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">sizeof_hdr</span> <span class="p">=</span> <span class="mi">348</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">data_type</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">db_name</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">extents</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">session_error</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">regular</span><span class="p">=</span><span class="s">&#39;r&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hk</span><span class="p">.</span><span class="n">dim_info</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">descrip</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">aux_file</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">intent_name</span><span class="p">=</span><span class="s">&#39;&#39;</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_x</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">2</span> <span class="mi">0</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span> <span class="p">];</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_y</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span> <span class="p">];</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_z</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">2</span> <span class="o">-</span><span class="mi">1</span> <span class="p">];</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_c</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">originator</span> <span class="p">=</span> <span class="p">[</span> <span class="mi">2</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="p">];</span>

    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">sform_code</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qform_code</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c">% set up qform</span>
    <span class="n">m</span><span class="p">=[</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_x</span><span class="p">;</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_y</span><span class="p">;</span><span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">srow_z</span><span class="p">];</span>
    <span class="n">quatern_a</span><span class="p">=.</span><span class="mi">5</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_b</span> <span class="p">=</span> <span class="p">.</span><span class="mi">25</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="n">quatern_a</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_c</span> <span class="p">=</span> <span class="p">.</span><span class="mi">25</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">quatern_a</span><span class="p">;</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">quatern_d</span> <span class="p">=</span> <span class="p">.</span><span class="mi">25</span><span class="o">*</span><span class="p">(</span><span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">quatern_a</span><span class="p">;</span>

    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qoffset_x</span> <span class="p">=</span> <span class="n">m</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qoffset_y</span> <span class="p">=</span> <span class="n">m</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">hdr</span><span class="p">.</span><span class="n">hist</span><span class="p">.</span><span class="n">qoffset_z</span> <span class="p">=</span> <span class="n">m</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>

    <span class="n">data</span><span class="p">=</span><span class="nb">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)=[</span> <span class="mf">2.0317</span>  <span class="mf">1.3494</span><span class="p">;</span> <span class="o">-</span><span class="mf">3.6849</span> <span class="o">-</span><span class="mf">0.2617</span><span class="p">;</span> <span class="o">-</span><span class="mf">1.0504</span>   <span class="o">-</span><span class="mf">0.2040</span><span class="p">];</span>
    <span class="n">data</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)=[</span> <span class="mf">0.5838</span> <span class="o">-</span><span class="mf">0.3973</span><span class="p">;</span>  <span class="mf">1.7235</span>  <span class="mf">2.3387</span><span class="p">;</span> <span class="o">-</span><span class="mf">1.3265</span>    <span class="mf">0.4823</span><span class="p">];</span>

    <span class="n">nii</span><span class="p">=</span><span class="n">struct</span><span class="p">();</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">hdr</span><span class="p">=</span><span class="n">hdr</span><span class="p">;</span>
    <span class="n">nii</span><span class="p">.</span><span class="n">img</span><span class="p">=</span><span class="n">single</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="k">function</span><span class="w"> </span>s<span class="p">=</span><span class="nf">clear_fields</span><span class="p">(</span>s,keys<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">n</span><span class="p">=</span><span class="nb">numel</span><span class="p">(</span><span class="n">keys</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">=</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span>
        <span class="n">key</span><span class="p">=</span><span class="n">keys</span><span class="p">{</span><span class="n">k</span><span class="p">};</span>
        <span class="n">v</span><span class="p">=</span><span class="n">s</span><span class="p">.(</span><span class="n">key</span><span class="p">);</span>
        <span class="n">v</span><span class="p">(:)=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">s</span><span class="p">.(</span><span class="n">key</span><span class="p">)=</span><span class="n">v</span><span class="p">;</span>
    <span class="k">end</span>

<span class="k">function</span><span class="w"> </span>result<span class="p">=</span><span class="nf">neuroelf_bless_wrapper</span><span class="p">(</span>arg<span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="c">% deals with recent neuroelf (&gt;v1.1), where bless is deprecated</span>
    <span class="n">s</span><span class="p">=</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;off&#39;</span><span class="p">,</span><span class="s">&#39;neuroelf:xff:deprecated&#39;</span><span class="p">);</span>
    <span class="n">resetter</span><span class="p">=</span><span class="n">onCleanup</span><span class="p">(@()</span><span class="n">warning</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

    <span class="n">result</span><span class="p">=</span><span class="n">bless</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cosmomvpa_logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="test_fmri_convert_xform.html"
                        title="previous chapter">test fmri convert xform</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="test_fmri_deoblique.html"
                        title="next chapter">test fmri deoblique</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/matlab/test_fmri_dataset.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="test_fmri_deoblique.html" title="test fmri deoblique"
             >next</a> |</li>
        <li class="right" >
          <a href="test_fmri_convert_xform.html" title="test fmri convert xform"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">CoSMoMVPA</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../cimec2016.html" >CIMeC hands-on methods course, part 1 (6 April-2 May 2016)</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="../matindex_test.html" >CoSMoMVPA unit tests</a> &#187;</li> 
      </ul>
    </div>
      <div class="footer">
       <span class="creativecommons">
          <a href="http://opensource.org/licenses/MIT" >
          <img src="../_static/mit-license_logo.png"
               border="0" alt="Creative Commons License"/>
         </a> 
         
        <a href="copyright.html">Copyright 2013-2016 Nikolaas N. Oosterhof, Andrew C. Connolly, CoSMoMVPA contributors</a>.
        CoSMoMVPA is licensed under a <a href="http://opensource.org/licenses/MIT">Expat (MIT) License</a>.
       </span>
      </div>
  </body>
</html>